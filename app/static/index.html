<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhotoRecognition - Reconhecimento Facial</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --bg-card-rgb: 255, 255, 255;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --accent-color: #0d6efd;
            --accent-hover: #0b5ed7;
            --success-color: #198754;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 8px 25px rgba(0, 0, 0, 0.15);
            --card-opacity: 1;
            --face-size: 80px;
            --card-size: 100px;
            --text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #0d1117;
                --bg-secondary: #161b22;
                --bg-card: #21262d;
                --bg-card-rgb: 33, 38, 45;
                --text-primary: #f0f6fc;
                --text-secondary: #8b949e;
                --border-color: #30363d;
                --accent-color: #58a6ff;
                --accent-hover: #79c0ff;
                --success-color: #3fb950;
                --danger-color: #f85149;
                --warning-color: #d29922;
                --shadow: 0 4px 6px rgba(0, 0, 0, 0.4);
                --shadow-hover: 0 8px 25px rgba(0, 0, 0, 0.5);
                --text-shadow: 0 1px 4px rgba(0, 0, 0, 0.5);
            }
        }

        * { transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; }
        html, body { height: 100%; margin: 0; }
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            position: relative;
            text-shadow: var(--text-shadow);
        }
        /* Remove text shadow from inputs and specific elements */
        input, textarea, select, button, .btn, .badge { text-shadow: none; }
        /* Bing Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            z-index: -1;
            opacity: 0;
            transition: opacity 1s ease;
        }
        body.has-bg::before {
            opacity: 1;
        }
        /* Transparency slider */
        .transparency-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(var(--bg-card-rgb), var(--card-opacity));
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.85rem;
        }
        .transparency-control input[type="range"] {
            width: 100px;
            cursor: pointer;
        }
        .transparency-control .value {
            min-width: 35px;
            text-align: right;
        }
        /* Header controls bar */
        .controls-bar {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
            background: rgba(var(--bg-card-rgb), var(--card-opacity));
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 0.5rem 1rem;
        }
        .controls-bar .btn {
            border: none;
            background: transparent;
        }
        .controls-bar .btn:hover {
            background: rgba(var(--bg-card-rgb), 0.5);
        }

        .app-header {
            background: linear-gradient(135deg, var(--accent-color), #6f42c1);
            padding: 1rem 0;
            box-shadow: var(--shadow);
        }
        .app-header h1 { color: white; font-weight: 700; margin: 0; display: flex; align-items: center; justify-content: center; gap: 0.75rem; font-size: 1.5rem; }

        .main-content { flex: 1; overflow-y: auto; padding-bottom: 1rem; }

        /* Footer Status Bar */
        .status-footer {
            background: rgba(var(--bg-card-rgb), var(--card-opacity));
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-color);
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            flex-wrap: wrap;
            font-size: 0.85rem;
        }
        .status-footer .stat-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
        }
        .status-footer .stat-value {
            font-weight: 600;
            color: var(--accent-color);
        }
        .status-footer .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .status-footer .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.8rem;
        }
        .capture-footer {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.82rem;
            white-space: nowrap;
            position: relative;
        }
        .capture-footer-text {
            max-width: 280px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: inline-block;
        }
        .capture-tooltip {
            position: absolute;
            bottom: calc(100% + 8px);
            right: 0;
            background: rgba(15, 23, 42, 0.95);
            color: #fff;
            padding: 0.5rem 0.6rem;
            border-radius: 8px;
            min-width: 240px;
            max-width: 360px;
            font-size: 0.75rem;
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 3000;
        }
        .capture-footer:hover .capture-tooltip {
            display: block;
        }
        .capture-tooltip-item {
            display: flex;
            justify-content: space-between;
            gap: 0.5rem;
            padding: 0.25rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .capture-tooltip-item:last-child {
            border-bottom: none;
        }
        #captureFolderModal {
            z-index: 2000;
        }
        #captureFolderModal .modal-dialog {
            z-index: 2001;
        }
        .modal-backdrop.capture-folder-backdrop {
            z-index: 1990;
        }
        .capture-log-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-height: 70vh;
            overflow-y: auto;
        }
        .capture-log-item {
            display: flex;
            gap: 0.75rem;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background: rgba(var(--bg-card-rgb), 0.7);
        }
        .capture-log-thumb {
            width: 120px;
            height: 90px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
        }
        .capture-log-info {
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 0.2rem;
            font-size: 0.85rem;
        }
        .capture-log-info strong {
            font-size: 0.95rem;
        }
        .capture-tooltip-name {
            font-weight: 600;
        }
        .capture-tooltip-time {
            color: rgba(255, 255, 255, 0.7);
            white-space: nowrap;
        }
        .status-badge.idle { background: var(--bg-secondary); color: var(--text-secondary); border: 1px solid var(--border-color); }
        .status-badge.scanning { background: linear-gradient(135deg, var(--success-color), #20c997); color: white; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        .nav-tabs { border: none; background: rgba(var(--bg-card-rgb), var(--card-opacity)); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 12px; padding: 0.5rem; margin-bottom: 1.5rem; box-shadow: var(--shadow); flex-wrap: nowrap; overflow-x: auto; }
        .nav-tabs .nav-link { border: none; border-radius: 8px; color: var(--text-secondary); font-weight: 500; padding: 0.75rem 1rem; display: flex; align-items: center; gap: 0.5rem; white-space: nowrap; }
        .nav-tabs .nav-link:hover { background: var(--bg-secondary); color: var(--text-primary); }
        .nav-tabs .nav-link.active { background: var(--accent-color); color: white; }

        .card { background: rgba(var(--bg-card-rgb), var(--card-opacity)); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid var(--border-color); border-radius: 16px; box-shadow: var(--shadow); }
        .card-title { color: var(--text-primary); font-weight: 600; }

        .photo-card { background: rgba(var(--bg-card-rgb), var(--card-opacity)); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden; transition: all 0.3s ease; cursor: pointer; }
        .photo-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-hover); border-color: var(--accent-color); }
        .photo-card .thumbnail { height: 180px; object-fit: cover; width: 100%; }
        .photo-card .card-body { padding: 0.75rem; background: rgba(var(--bg-card-rgb), var(--card-opacity)); }
        .photo-card .filename { font-size: 0.8rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .photo-card .date { font-size: 0.75rem; color: var(--text-secondary); }
        .photo-card .face-count { background: var(--accent-color); color: white; padding: 0.25rem 0.75rem; border-radius: 50px; font-size: 0.75rem; font-weight: 600; }
        .photo-card .match-score { background: var(--success-color); color: white; padding: 0.25rem 0.75rem; border-radius: 50px; font-size: 0.75rem; font-weight: 600; }

        /* Person Cards - Google Photos Style */
        .person-card { text-align: center; cursor: pointer; padding: 1rem; border-radius: 16px; transition: all 0.3s ease; }
        .person-card:hover { background: var(--bg-secondary); transform: scale(1.05); }
        .person-avatar { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid var(--border-color); margin: 0 auto 0.75rem; box-shadow: var(--shadow); transition: all 0.3s ease; }
        .person-card:hover .person-avatar { border-color: var(--accent-color); }
        .person-name { font-weight: 600; color: var(--text-primary); font-size: 1rem; margin-bottom: 0.25rem; }
        .person-count { color: var(--text-secondary); font-size: 0.85rem; }

        /* Person Detail Photos */
        .person-photo-card { position: relative; border-radius: 12px; overflow: hidden; }
        .person-photo-card img { width: 100%; height: 150px; object-fit: cover; }
        .person-photo-card .remove-btn { position: absolute; top: 8px; right: 8px; background: var(--danger-color); color: white; border: none; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; opacity: 0; transition: opacity 0.2s; font-size: 14px; z-index: 10; }
        .person-photo-card:hover .remove-btn { opacity: 1; }
        .person-photo-card .remove-btn:hover { background: #c82333; transform: scale(1.1); }
        .person-photo-card .face-marker { position: absolute; border: 3px solid #00ff88; border-radius: 4px; box-shadow: 0 0 10px rgba(0, 255, 136, 0.7); pointer-events: none; opacity: 0; transform: scale(0.96); transition: opacity 0.2s ease, transform 0.2s ease; }
        .person-photo-card .face-marker.marker-ready { opacity: 1; transform: scale(1); }
        .person-photo-card .marker-loading { position: absolute; inset: 10px; border: 2px dashed rgba(0, 255, 136, 0.6); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: rgba(0, 255, 136, 0.9); font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.08em; background: rgba(0, 0, 0, 0.35); }
        .person-photo-card.selectable { cursor: pointer; }
        .person-photo-card.selectable::before { content: ''; position: absolute; top: 8px; left: 8px; width: 24px; height: 24px; border: 2px solid white; border-radius: 4px; background: rgba(0,0,0,0.3); z-index: 5; }
        .person-photo-card.selectable.selected::before { background: var(--success-color); border-color: var(--success-color); }
        .person-photo-card.selectable.selected::after { content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; position: absolute; top: 10px; left: 12px; color: white; font-size: 14px; z-index: 6; }
        .person-photo-card.selectable.selected { outline: 3px solid var(--success-color); }

        .recognition-list { display: flex; flex-direction: column; gap: 0.5rem; }
        .recognition-item { border: 1px solid var(--border-color); background: rgba(var(--bg-card-rgb), var(--card-opacity)); color: var(--text-primary); border-radius: 10px; padding: 0.6rem 0.75rem; display: flex; align-items: center; gap: 0.75rem; width: 100%; text-align: left; transition: border-color 0.2s ease, transform 0.2s ease; }
        .recognition-item:hover { border-color: var(--accent-color); transform: translateX(2px); }
        .recognition-item:active { transform: translateX(1px); }
        .recognition-icon { width: 32px; height: 32px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; background: rgba(25, 135, 84, 0.15); color: var(--success-color); }
        .recognition-item.recognition-unknown { cursor: default; opacity: 0.75; }
        .recognition-item.recognition-unknown .recognition-icon { background: rgba(220, 53, 69, 0.15); color: var(--danger-color); }
        .recognition-text { flex: 1; display: flex; flex-direction: column; gap: 0.1rem; }
        .recognition-score { font-size: 0.75rem; color: var(--text-secondary); margin-left: 0.35rem; }
        .recognition-action { color: var(--text-secondary); }
        .recognition-history-item { padding: 0.45rem 0.6rem; }
        .recognition-history-time { font-size: 0.7rem; color: var(--text-secondary); }
        .recognition-history-empty { color: var(--text-secondary); font-size: 0.8rem; text-align: center; padding: 0.5rem 0; }
        .capture-breadcrumb { display: flex; flex-wrap: wrap; gap: 0.4rem; align-items: center; }
        .capture-breadcrumb button { border: none; background: transparent; color: var(--accent-color); padding: 0; font-size: 0.85rem; }
        .capture-breadcrumb span { color: var(--text-secondary); font-size: 0.85rem; }
        .capture-folder-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.6rem; border-radius: 8px; cursor: pointer; }
        .capture-folder-item:hover { background: rgba(255,255,255,0.06); }

        .live-video-panel { min-height: 260px; background: #000; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); }
        .live-video-wrapper video,
        .live-video-wrapper img { width: 100%; max-height: 320px; border-radius: 12px; object-fit: cover; }
        .live-video-panel.pip-active { position: fixed; bottom: 20px; right: 20px; width: 320px; height: 180px; z-index: 2000; box-shadow: 0 12px 24px rgba(0,0,0,0.4); cursor: pointer; }
        .live-video-panel.pip-active video,
        .live-video-panel.pip-active img { max-height: 100%; border-radius: 12px; }
        .live-video-panel.pip-active .pip-handle { position: absolute; right: 8px; bottom: 8px; width: 16px; height: 16px; background: rgba(255,255,255,0.8); border-radius: 4px; cursor: nwse-resize; }
        .live-video-panel.pip-active .pip-handle::after { content: ''; position: absolute; right: 4px; bottom: 4px; width: 8px; height: 8px; border-right: 2px solid #333; border-bottom: 2px solid #333; }
        #liveGroupsContainer .group-container { margin-bottom: 1rem; }

        .btn-primary { background: var(--accent-color); border: none; border-radius: 8px; font-weight: 500; padding: 0.6rem 1.25rem; }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-outline-primary { border-color: var(--accent-color); color: var(--accent-color); border-radius: 8px; }
        .btn-outline-primary:hover { background: var(--accent-color); color: white; }
        .btn-success { background: var(--success-color); border: none; border-radius: 8px; }
        .btn-danger { background: var(--danger-color); border: none; border-radius: 8px; }

        .form-control, .form-select { background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 8px; padding: 0.6rem 1rem; }
        .form-control:focus, .form-select:focus { background: var(--bg-secondary); border-color: var(--accent-color); color: var(--text-primary); box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.15); }
        .form-control::placeholder { color: var(--text-secondary); }
        .form-label { color: var(--text-secondary); font-size: 0.9rem; font-weight: 500; }

        .modal-content { background: rgba(var(--bg-card-rgb), var(--card-opacity)); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid var(--border-color); border-radius: 16px; }
        .modal-header { border-bottom: 1px solid var(--border-color); padding: 1rem 1.5rem; }
        .modal-title { color: var(--text-primary); font-weight: 600; }
        .modal-body.photo-view { background: #000; padding: 1rem; min-height: 400px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .modal-footer { border-top: 1px solid var(--border-color); }
        .btn-close { filter: var(--bs-btn-close-white-filter); }
        @media (prefers-color-scheme: dark) { .btn-close { filter: invert(1); } }

        .face-box { position: absolute; border: 3px solid #00ff88; border-radius: 4px; cursor: pointer; background: rgba(0, 255, 136, 0.15); box-shadow: 0 0 10px rgba(0, 255, 136, 0.5); transition: all 0.2s ease; }
        .face-box:hover { border-color: #ffffff; background: rgba(255, 255, 255, 0.25); box-shadow: 0 0 20px rgba(255, 255, 255, 0.7); transform: scale(1.02); }
        .face-box::after { content: 'Clique para buscar'; position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.8); color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; white-space: nowrap; opacity: 0; transition: opacity 0.2s; }
        .face-box:hover::after { opacity: 1; }

        .folder-list { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; max-height: 300px; overflow-y: auto; padding: 0.5rem; }
        .folder-item { display: flex; align-items: center; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.25rem; }
        .folder-item:hover { background: var(--bg-card); }
        .folder-item input { margin-right: 0.75rem; }
        .folder-item label { color: var(--text-primary); cursor: pointer; display: flex; align-items: center; gap: 0.5rem; }

        .loading-container { text-align: center; padding: 3rem; }
        .loading-container .spinner-border { width: 3rem; height: 3rem; color: var(--accent-color); }
        .loading-container p { color: var(--text-secondary); margin-top: 1rem; }
        .empty-state { text-align: center; padding: 3rem; color: var(--text-secondary); }
        .empty-state i { font-size: 3rem; opacity: 0.5; margin-bottom: 1rem; display: block; }

        .alert { border-radius: 8px; border: none; }
        .alert-warning { background: rgba(255, 193, 7, 0.15); color: #ffc107; }
        .alert-info { background: rgba(13, 110, 253, 0.15); color: var(--accent-color); }

        /* Fix form-check-label color in dark/light mode */
        .form-check-label { color: var(--text-primary) !important; }

        /* Photo Viewer Navigation */
        .photo-nav-btn { opacity: 0.6; transition: opacity 0.2s; border-radius: 50%; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; }
        .photo-nav-btn:hover { opacity: 1; }

        /* Scan Context Menu */
        .scan-context-menu {
            position: fixed;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: var(--shadow-hover);
            padding: 0.5rem 0;
            z-index: 9999;
            min-width: 150px;
        }
        .scan-context-menu button {
            display: block;
            width: 100%;
            padding: 0.5rem 1rem;
            background: none;
            border: none;
            color: var(--text-primary);
            text-align: left;
            cursor: pointer;
            transition: background 0.2s;
        }
        .scan-context-menu button:hover { background: var(--bg-secondary); }
        .scan-context-menu button i { width: 20px; margin-right: 0.5rem; }
        .status-badge.scanning { cursor: context-menu; }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }

        .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .results-count { background: var(--accent-color); color: white; padding: 0.25rem 0.75rem; border-radius: 50px; font-size: 0.9rem; font-weight: 600; }

        /* Editable name input */
        .editable-name { display: flex; align-items: center; gap: 0.5rem; justify-content: center; }
        .editable-name input { background: transparent; border: none; border-bottom: 2px solid var(--accent-color); color: var(--text-primary); font-size: 1.5rem; font-weight: 600; text-align: center; max-width: 200px; }
        .editable-name input:focus { outline: none; }

        /* Merge mode */
        .person-card.merge-mode { position: relative; }
        .person-card.merge-mode::before { content: ''; position: absolute; top: 8px; right: 8px; width: 28px; height: 28px; border: 3px solid var(--border-color); border-radius: 50%; background: var(--bg-card); z-index: 10; }
        .person-card.merge-mode.selected::before { background: var(--success-color); border-color: var(--success-color); }
        .person-card.merge-mode.selected::after { content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; position: absolute; top: 12px; right: 14px; color: white; font-size: 14px; z-index: 11; }
        .person-card.merge-mode.selected { background: rgba(25, 135, 84, 0.15); }
        .person-card.merge-mode.selected .person-avatar { border-color: var(--success-color); }

        /* Drag and Drop */
        .person-card.dragging { opacity: 0.5; transform: scale(0.95); }
        .person-card.drag-over { background: rgba(13, 110, 253, 0.2); border: 2px dashed var(--accent-color); border-radius: 16px; }
        .person-card.drag-over .person-avatar { border-color: var(--accent-color); }

        /* Group Containers */
        .group-container {
            background: rgba(var(--bg-card-rgb), var(--card-opacity));
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }
        .group-container.drag-over {
            border-color: var(--accent-color);
            box-shadow: 0 0 20px rgba(13, 110, 253, 0.3);
        }
        .group-header {
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }
        .group-header:hover {
            background: var(--bg-secondary);
        }
        .group-header .group-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .group-header .group-name {
            font-weight: 600;
            font-size: 1.1rem;
            flex: 1;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .icon-pick {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: rgba(var(--bg-card-rgb), var(--card-opacity));
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }
        .icon-pick:hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
        }
        .icon-pick.selected {
            border-color: var(--accent-color);
            color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.2);
        }
        .group-header .group-count {
            background: var(--bg-secondary);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .group-header .group-actions {
            display: flex;
            gap: 0.5rem;
        }
        .group-header .group-actions button {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .group-header:hover .group-actions button {
            opacity: 1;
        }
        .group-content {
            padding: 1rem;
            min-height: 80px;
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            align-content: flex-start;
        }
        .group-content.empty {
            justify-content: center;
            align-items: center;
            color: var(--text-secondary);
            font-style: italic;
        }
        .group-container.collapsed .group-content {
            display: none;
        }
        .group-container.collapsed .group-header {
            border-bottom: none;
        }
        /* Mini person card for inside groups */
        .person-mini-card {
            width: var(--card-size);
            text-align: center;
            cursor: grab;
            transition: transform 0.2s, width 0.3s;
        }
        .person-mini-card:hover {
            transform: scale(1.05);
        }
        .person-mini-card.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }
        .person-mini-card img {
            width: var(--face-size);
            height: var(--face-size);
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--border-color);
            transition: border-color 0.2s, box-shadow 0.2s, width 0.3s, height 0.3s;
        }
        .person-mini-card:hover img {
            border-color: var(--accent-color);
        }
        .person-mini-card.drag-over {
            transform: scale(1.1);
        }
        .person-mini-card.drag-over img {
            border-color: var(--warning-color);
            box-shadow: 0 0 15px rgba(255, 193, 7, 0.5);
        }
        .person-mini-card .name {
            font-size: 0.8rem;
            font-weight: 500;
            margin-top: 0.35rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .person-mini-card .count {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }
        .add-group-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            background: rgba(var(--bg-card-rgb), var(--card-opacity));
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 1.5rem;
        }
        .add-group-btn:hover {
            border-color: var(--success-color);
            color: var(--success-color);
            background: rgba(var(--bg-card-rgb), 0.95);
        }
        /* Controls with glass effect */
        .glass-control {
            background: rgba(var(--bg-card-rgb), var(--card-opacity));
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.4rem 0.75rem;
        }

        /* Merge Suggestions */
        .suggestion-card {
            background: rgba(var(--bg-card-rgb), var(--card-opacity));
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .suggestion-card .person-pair {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
        }
        .suggestion-card .person-mini {
            text-align: center;
        }
        .suggestion-card .person-mini img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--border-color);
        }
        .suggestion-card .person-mini .name {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .suggestion-card .similarity {
            background: var(--success-color);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        .suggestion-card .arrow {
            font-size: 1.5rem;
            color: var(--text-secondary);
        }

        /* Welcome Modal Styling */
        .welcome-modal .modal-body {
            text-align: center;
            padding: 2rem;
        }
        .welcome-modal .welcome-icon {
            font-size: 4rem;
            color: var(--accent-color);
            margin-bottom: 1rem;
        }
        .welcome-modal h2 {
            color: var(--text-primary);
            margin-bottom: 1rem;
        }
        .welcome-modal p {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }
        .welcome-modal .feature-list {
            text-align: left;
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
        }
        .welcome-modal .feature-list li {
            color: var(--text-primary);
            padding: 0.5rem 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .welcome-modal .feature-list i {
            color: var(--success-color);
            width: 20px;
        }

        /* Photo Details Panel */
        .photo-detail-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 0.85rem;
        }
        .photo-detail-item:last-child {
            border-bottom: none;
        }
        .photo-detail-label {
            color: #adb5bd;
            font-weight: 500;
            flex-shrink: 0;
            margin-right: 0.5rem;
        }
        .photo-detail-value {
            color: #fff;
            text-align: right;
            word-break: break-word;
        }
        .photo-detail-value.clickable {
            color: #58a6ff;
            cursor: pointer;
            text-decoration: underline;
            text-decoration-style: dotted;
        }
        .photo-detail-value.clickable:hover {
            color: #79c0ff;
            text-decoration-style: solid;
        }
        .photo-detail-section {
            margin-top: 1rem;
            padding-top: 0.5rem;
            border-top: 1px solid rgba(255,255,255,0.2);
        }
        .photo-detail-section h6 {
            font-size: 0.8rem;
            color: #adb5bd;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }
        #photoDetailsPanel {
            transition: width 0.3s ease;
        }
        #photoDetailsPanel.show {
            display: block !important;
        }

        /* Clickable stats in footer */
        .stat-clickable {
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .stat-clickable:hover {
            background-color: rgba(255,255,255,0.1);
        }

        /* All Photos Modal Grid */
        .all-photos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 0.5rem;
            max-height: 70vh;
            overflow-y: auto;
            padding: 0.5rem;
        }
        .all-photos-grid .photo-thumb {
            aspect-ratio: 1;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .all-photos-grid .photo-thumb:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>

<header class="app-header">
    <div class="container">
        <h1><i class="fas fa-camera-retro"></i> PhotoRecognition</h1>
    </div>
</header>

<div class="main-content">
    <div class="container py-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <ul class="nav nav-tabs flex-grow-1 mb-0" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="persons-tab" data-bs-toggle="tab" data-bs-target="#persons" type="button" onclick="loadPersons()">
                        <i class="fas fa-users"></i> Pessoas
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" onclick="loadFolders()">
                        <i class="fas fa-cog"></i> Configurações
                    </button>
                </li>
            </ul>

            <div class="ms-3 transparency-control d-flex align-items-center gap-2" title="Transparência dos cards">
                <i class="fas fa-adjust"></i>
                <input type="range" id="transparencySlider" min="0" max="100" value="0" oninput="updateTransparency(this.value)" style="width: 80px;">
                <span id="transparencyValue" style="min-width: 32px;">0%</span>
            </div>
        </div>

        <div class="tab-content" id="myTabContent">

            <!-- Persons Tab (Google Photos Style) with Live Video and Search -->
            <div class="tab-pane fade show active" id="persons" role="tabpanel">
                <div class="row g-3">
                    <!-- Left Column: Live Video + Recognition -->
                    <div class="col-lg-3">
                        <div class="card p-3 mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="card-title mb-0"><i class="fas fa-video text-success"></i> Ao Vivo</h6>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="liveEnabled" onchange="toggleLiveMode()">
                                    <label class="form-check-label small" for="liveEnabled">Ativo</label>
                                </div>
                            </div>
                            <div class="mb-2">
                                <div class="input-group input-group-sm">
                                    <select id="liveVideoSource" class="form-select form-select-sm">
                                        <option value="webcam">Webcam Local</option>
                                        <option value="custom">URL RTSP</option>
                                        <optgroup label="Câmeras Salvas" id="savedCamerasOptions"></optgroup>
                                    </select>
                                    <button class="btn btn-outline-secondary btn-sm" type="button" onclick="discoverCameras()" title="Procurar Câmeras ONVIF">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="mb-2 d-none" id="liveOnvifCredentials">
                                <div class="row g-1">
                                    <div class="col-12">
                                        <input type="text" id="liveOnvifIp" class="form-control form-control-sm" placeholder="IP ONVIF" value="172.16.0.177" aria-label="IP ONVIF">
                                    </div>
                                    <div class="col-6">
                                        <input type="text" id="liveOnvifUser" class="form-control form-control-sm" placeholder="Usuário" aria-label="Usuário ONVIF">
                                    </div>
                                    <div class="col-6">
                                        <input type="password" id="liveOnvifPass" class="form-control form-control-sm" placeholder="Senha" aria-label="Senha ONVIF">
                                    </div>
                                </div>
                            </div>
                            <div id="liveCustomRtspDiv" class="mb-2 d-none">
                                <input type="text" id="liveCustomRtspUrl" class="form-control form-control-sm" placeholder="rtsp://ip:554/stream">
                            </div>
                            <div class="mb-2">
                                <label class="form-label small mb-1" for="liveQuality">Qualidade</label>
                                <select id="liveQuality" class="form-select form-select-sm">
                                    <option value="auto">Automatica</option>
                                    <option value="360p">Baixa (640x360)</option>
                                    <option value="480p">Media (854x480)</option>
                                    <option value="720p">Alta (1280x720)</option>
                                    <option value="1080p">Ultra (1920x1080)</option>
                                </select>
                            </div>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="liveLowLatency" checked>
                                <label class="form-check-label small" for="liveLowLatency">Baixa latencia</label>
                            </div>
                            <div class="live-video-wrapper">
                                <div id="liveVideoContainer" class="live-video-panel" style="min-height: 180px;">
                                    <div class="text-secondary">
                                        <i class="fas fa-video fa-2x mb-2 d-block"></i>
                                        <small>Ative para iniciar</small>
                                    </div>
                                </div>
                                <div id="liveVideoStatus" class="mt-1 text-center text-secondary small">
                                    Desconectado
                                </div>
                            </div>
                        </div>
                        <div class="card p-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="card-title mb-0"><i class="fas fa-user-check text-primary"></i> Reconhecimento</h6>
                                <button class="btn btn-sm btn-outline-secondary" onclick="toggleRecognitionHistory()" title="Histórico">
                                    <i class="fas fa-history"></i>
                                </button>
                            </div>
                            <div id="liveRecognitionResults">
                                <div class="text-secondary text-center py-2 small">
                                    <i class="fas fa-video-slash"></i> Vídeo não iniciado
                                </div>
                            </div>
                            <div id="recognitionHistory" class="mt-2 d-none">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <span class="text-secondary small">Histórico</span>
                                    <button class="btn btn-sm btn-outline-secondary py-0" onclick="clearRecognitionHistory()" title="Limpar">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                <div id="recognitionHistoryList"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Middle Column: Persons List -->
                    <div class="col-lg-6">
                        <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
                            <h5 class="mb-0"><i class="fas fa-users"></i> Pessoas</h5>
                            <div class="d-flex gap-1 flex-wrap align-items-center">
                                <div class="controls-bar py-1 px-2">
                                    <div class="form-check form-check-inline mb-0">
                                        <input class="form-check-input" type="checkbox" id="showFaceMarkers" checked onchange="toggleFaceMarkersVisibility()">
                                        <label class="form-check-label small" for="showFaceMarkers"><i class="fas fa-crosshairs"></i></label>
                                    </div>
                                    <button id="btnSuggestions" onclick="showMergeSuggestions()" class="btn btn-sm text-info p-1" title="Sugestões de mesclagem">
                                        <i class="fas fa-lightbulb"></i>
                                    </button>
                                    <button onclick="triggerRecluster()" class="btn btn-sm p-1" title="Re-agrupar rostos órfãos">
                                        <i class="fas fa-object-group"></i>
                                    </button>
                                    <button onclick="loadPersons()" class="btn btn-sm text-primary p-1" title="Recarregar">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Search and Sort for Persons -->
                        <div class="d-flex gap-2 mb-2">
                            <div class="input-group input-group-sm flex-grow-1">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" id="personSearchInput" class="form-control" placeholder="Buscar pessoa..." oninput="filterPersonsByName()">
                            </div>
                            <select id="personSortSelect" class="form-select form-select-sm" style="width: auto;" onchange="sortPersons()">
                                <option value="photos_desc">Mais fotos</option>
                                <option value="photos_asc">Menos fotos</option>
                                <option value="name_asc">Nome A-Z</option>
                                <option value="name_desc">Nome Z-A</option>
                                <option value="recent">Mais recente</option>
                            </select>
                        </div>

                        <div id="suggestionsContainer" class="d-none mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0"><i class="fas fa-lightbulb text-warning"></i> Sugestões</h6>
                                <button onclick="hideSuggestions()" class="btn btn-sm btn-outline-secondary p-1"><i class="fas fa-times"></i></button>
                            </div>
                            <div id="suggestionsList"></div>
                        </div>

                        <!-- Groups containers with persons inside -->
                        <div id="groupsContainers">
                            <div class="loading-container">
                                <div class="spinner-border" role="status"></div>
                                <p>Carregando pessoas...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Search -->
                    <div class="col-lg-3">
                        <div class="card p-3 mb-3">
                            <h6 class="card-title mb-2"><i class="fas fa-user-check text-primary"></i> Busca por Rosto</h6>
                            <p class="text-secondary small mb-2">Envie uma foto para encontrar a pessoa.</p>
                            <div class="mb-2">
                                <input type="file" id="faceInput" class="form-control form-control-sm" accept="image/*">
                            </div>
                            <button onclick="searchFace()" class="btn btn-primary btn-sm w-100">
                                <i class="fas fa-search"></i> Buscar
                            </button>
                        </div>
                        <div class="card p-3 mb-3">
                            <h6 class="card-title mb-2"><i class="fas fa-filter text-primary"></i> Filtros de Fotos</h6>
                            
                            <!-- Quick date filters -->
                            <div class="mb-2">
                                <div class="btn-group btn-group-sm w-100" role="group">
                                    <button type="button" class="btn btn-outline-secondary" onclick="setQuickDateFilter('today')" title="Hoje">
                                        <i class="fas fa-calendar-day"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="setQuickDateFilter('week')" title="Esta semana">
                                        <i class="fas fa-calendar-week"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="setQuickDateFilter('month')" title="Este mês">
                                        <i class="fas fa-calendar-alt"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="setQuickDateFilter('year')" title="Este ano">
                                        <i class="fas fa-calendar"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mb-2">
                                <label class="form-label small mb-1" for="startDate">Data Inicial</label>
                                <input type="date" id="startDate" class="form-control form-control-sm">
                            </div>
                            <div class="mb-2">
                                <label class="form-label small mb-1" for="endDate">Data Final</label>
                                <input type="date" id="endDate" class="form-control form-control-sm">
                            </div>
                            <div class="mb-2">
                                <label class="form-label small mb-1" for="cameraModel">Câmera</label>
                                <input type="text" id="cameraModel" class="form-control form-control-sm" placeholder="Ex: iPhone, Canon">
                            </div>
                            <div class="d-flex gap-1">
                                <button onclick="searchMetadata()" class="btn btn-primary btn-sm flex-grow-1">
                                    <i class="fas fa-search"></i> Buscar
                                </button>
                                <button onclick="clearPhotoFilters()" class="btn btn-outline-secondary btn-sm" title="Limpar filtros">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card p-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="card-title mb-0"><i class="fas fa-images"></i> Resultados</h6>
                                <span id="resultCount" class="badge bg-primary">0</span>
                            </div>
                            <div id="resultsGrid" class="row g-2" style="max-height: 400px; overflow-y: auto;">
                                <div class="empty-state py-3">
                                    <i class="fas fa-search"></i>
                                    <p class="small mb-0">Resultados aqui</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-pane fade" id="settings" role="tabpanel">
                <h3 class="mb-4"><i class="fas fa-cog"></i> Configurações</h3>
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card p-4 h-100">
                            <h4 class="card-title mb-3"><i class="fas fa-radar text-success"></i> Scanner</h4>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <p class="mb-0 text-secondary">Pastas selecionadas:</p>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-primary" onclick="openScanFolderModal()"><i class="fas fa-folder-open"></i> Selecionar</button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="clearScanFolders()"><i class="fas fa-times"></i> Limpar</button>
                                </div>
                            </div>
                            <div id="folderList" class="folder-list mb-3">
                                <div class="text-center text-secondary py-3"><i class="fas fa-spinner fa-spin"></i> Carregando...</div>
                            </div>
                            <div class="alert alert-warning small mb-3">
                                <i class="fas fa-exclamation-triangle"></i> O scan pode demorar.
                            </div>
                            <button onclick="triggerScan()" class="btn btn-success w-100"><i class="fas fa-play"></i> Iniciar Scan</button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card p-4 mb-4">
                            <h4 class="card-title mb-3"><i class="fas fa-folder-tree text-warning"></i> Organizador</h4>
                            <p class="text-secondary mb-4">Organiza fotos por Ano/Mês baseado na data EXIF.</p>
                            <div class="mb-3">
                                <label class="form-label" for="organizeDestination">Destino</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="organizeDestination" placeholder="/mnt/organized" readonly>
                                    <button class="btn btn-outline-secondary" type="button" onclick="openOrganizeFolderModal()">
                                        <i class="fas fa-folder-open"></i>
                                    </button>
                                </div>
                                <small class="text-secondary">Selecionar o destino a cada execução.</small>
                            </div>
                            <div class="mb-4">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="orgMode" id="modeCopy" value="copy" checked>
                                    <label class="form-check-label" for="modeCopy"><i class="fas fa-copy text-primary"></i> Copiar (Seguro)</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="orgMode" id="modeMove" value="move">
                                    <label class="form-check-label" for="modeMove"><i class="fas fa-arrows-alt text-warning"></i> Mover</label>
                                </div>
                            </div>
                            <button onclick="triggerOrganize()" class="btn btn-warning w-100"><i class="fas fa-magic"></i> Organizar</button>
                        </div>
                        <div class="card p-4 mb-4">
                            <h4 class="card-title mb-3"><i class="fas fa-video text-success"></i> Reconhecimento Instantâneo</h4>
                            <p class="text-secondary mb-3">Salve URLs RTSP para reconhecimento instantâneo no modo Ao Vivo.</p>
                            <button onclick="openCameraModal()" class="btn btn-primary w-100 mb-3"><i class="fas fa-plus"></i> Nova Câmera</button>
                            <div id="savedCamerasList" class="mt-3"></div>
                        </div>
                        <div class="card p-4 border-danger mb-4">
                            <h4 class="card-title mb-3 text-danger"><i class="fas fa-trash-alt text-danger"></i> Limpar Histórico</h4>
                            <p class="text-secondary mb-3">Remove todos os dados indexados (fotos, rostos, pessoas). As fotos originais não serão afetadas.</p>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="rescanAfterReset">
                                <label class="form-check-label" for="rescanAfterReset">Reescanear após limpar</label>
                            </div>
                            <button onclick="resetAndRescan()" class="btn btn-danger w-100"><i class="fas fa-trash-alt"></i> Limpar Histórico</button>
                        </div>
                        <div class="card p-4">
                            <h4 class="card-title mb-3"><i class="fas fa-palette text-info"></i> Aparência</h4>
                            <div class="mb-3">
                                <label class="form-label" for="settingsTransparency"><i class="fas fa-adjust"></i> Transparência dos Cards</label>
                                <div class="d-flex align-items-center gap-2">
                                    <input type="range" class="form-range" id="settingsTransparency" min="0" max="100" value="0" oninput="updateTransparency(this.value)">
                                    <span id="settingsTransparencyValue" style="min-width: 40px;">0%</span>
                                </div>
                                <small class="text-secondary">0% = opaco, 100% = transparente</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label" for="settingsFaceSize"><i class="fas fa-user-circle"></i> Tamanho dos Rostos</label>
                                <div class="d-flex align-items-center gap-2">
                                    <input type="range" class="form-range" id="settingsFaceSize" min="60" max="120" value="80" oninput="updateFaceSize(this.value)">
                                    <span id="settingsFaceSizeValue" style="min-width: 45px;">80px</span>
                                </div>
                            </div>
                            <div class="mb-3">
                            <label class="form-label" for="settingsPersonPhotoLimit"><i class="fas fa-layer-group"></i> Fotos por Pessoa (Inicial)</label>
                                <div class="d-flex align-items-center gap-2">
                                    <input type="number" class="form-control" id="settingsPersonPhotoLimit" min="6" max="200" value="30">
                                    <span class="text-secondary">padrão</span>
                                </div>
                            <small class="text-secondary">Define o lote inicial carregado ao abrir uma pessoa. O restante carrega automaticamente.</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label" for="settingsPreloadCount"><i class="fas fa-forward"></i> Precarregar Próximas</label>
                                <div class="d-flex align-items-center gap-2">
                                    <input type="number" class="form-control" id="settingsPreloadCount" min="0" max="12" value="6">
                                    <span class="text-secondary">fotos</span>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label" for="settingsCacheMax"><i class="fas fa-hard-drive"></i> Limite do Cache (GB)</label>
                                <div class="d-flex align-items-center gap-2">
                                    <input type="number" class="form-control" id="settingsCacheMax" min="1" max="100" value="10" step="1">
                                    <span class="text-secondary">GB</span>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label" for="settingsWebpQuality"><i class="fas fa-image"></i> Qualidade WebP</label>
                                <div class="d-flex align-items-center gap-2">
                                    <input type="number" class="form-control" id="settingsWebpQuality" min="40" max="95" value="70" step="1">
                                    <span class="text-secondary">%</span>
                                </div>
                            </div>
                            <div class="d-flex gap-2 flex-wrap">
                                <button onclick="saveCacheSettings()" class="btn btn-primary btn-sm"><i class="fas fa-save"></i> Salvar Cache</button>
                                <button onclick="resetVisualSettings()" class="btn btn-outline-secondary btn-sm"><i class="fas fa-undo"></i> Restaurar Padrão</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Footer Status Bar -->
<footer class="status-footer">
    <div class="d-flex gap-3 flex-wrap">
        <div class="stat-item stat-clickable" onclick="openAllPhotosModal()" title="Ver todas as fotos">
            <i class="fas fa-images"></i>
            <span class="stat-value" id="statPhotos">0</span> fotos
        </div>
        <div class="stat-item stat-clickable" onclick="openAllPhotosModal('faces')" title="Ver fotos com rostos">
            <i class="fas fa-user-circle"></i>
            <span class="stat-value" id="statFaces">0</span> rostos
        </div>
        <div class="stat-item">
            <i class="fas fa-users"></i>
            <span class="stat-value" id="statPersons">0</span> pessoas
        </div>
    </div>
    <div class="status-indicator">
        <span id="captureFooter" class="capture-footer text-secondary">
            <i class="fas fa-camera"></i>
            <span id="captureFooterText" class="capture-footer-text">Sem capturas recentes</span>
            <div id="captureTooltip" class="capture-tooltip"></div>
        </span>
        <span id="sysDetail" class="text-secondary">Sistema pronto</span>
        <span id="sysState" class="status-badge idle"><i class="fas fa-circle"></i> Idle</span>
    </div>
</footer>

<!-- Welcome Modal -->
<div class="modal fade welcome-modal" id="welcomeModal" tabindex="-1" data-bs-backdrop="static" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <i class="fas fa-camera-retro welcome-icon"></i>
                <h2>Bem-vindo ao PhotoRecognition!</h2>
                <p>Sistema de reconhecimento facial e organização de fotos.</p>
                <ul class="feature-list list-unstyled">
                    <li><i class="fas fa-check"></i> Detecta rostos automaticamente</li>
                    <li><i class="fas fa-check"></i> Agrupa pessoas similares</li>
                    <li><i class="fas fa-check"></i> Busca por rosto ou metadados</li>
                    <li><i class="fas fa-check"></i> Organiza por data EXIF</li>
                </ul>
                <p class="text-secondary small">Para começar, selecione as pastas a escanear:</p>
                <div id="welcomeFolderList" class="folder-list mb-3" style="max-height: 200px;">
                    <div class="text-secondary p-3">Nenhuma pasta selecionada.</div>
                </div>
                <div class="d-flex gap-2 justify-content-center mb-3">
                    <button class="btn btn-sm btn-outline-primary" onclick="openScanFolderModal()"><i class="fas fa-folder-open"></i> Selecionar</button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="clearScanFolders()"><i class="fas fa-times"></i> Limpar</button>
                </div>
                <button onclick="startInitialScan()" class="btn btn-success btn-lg w-100">
                    <i class="fas fa-play"></i> Iniciar Scan
                </button>
                <button onclick="skipWelcome()" class="btn btn-link text-secondary mt-2">
                    Pular por agora
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Photo Detail Modal -->
<div class="modal fade" id="photoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-image"></i> Detalhes da Foto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body photo-view">
                <div id="imageContainer" style="position: relative; display: inline-block;">
                    <img id="modalImage" src="" class="img-fluid" style="max-height: 75vh; border-radius: 8px;">
                    <div id="faceOverlays"></div>
                </div>
                <p class="text-light mt-3 mb-0"><i class="fas fa-hand-pointer"></i> Clique em um rosto para buscar</p>
            </div>
        </div>
    </div>
</div>

<!-- Person Detail Modal -->
<div class="modal fade" id="personModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <div class="d-flex gap-3 align-items-center flex-wrap">
                    <div class="editable-name">
                        <input type="text" id="personNameInput" placeholder="Nome da pessoa" onchange="updatePersonName()">
                        <button class="btn btn-sm btn-outline-primary" onclick="updatePersonName()"><i class="fas fa-check"></i></button>
                    </div>
                    <select id="personGroupSelect" class="form-select form-select-sm" style="width: auto;" onchange="changePersonGroup()">
                        <option value="">Sem grupo</option>
                    </select>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Toolbar de acoes -->
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                    <div class="d-flex gap-2 align-items-center">
                        <button id="btnSelectMode" onclick="togglePhotoSelectMode()" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-check-square"></i> Selecionar
                        </button>
                        <span id="selectedCount" class="badge bg-primary d-none">0 selecionadas</span>
                    </div>
                    <div id="photoActions" class="d-flex gap-2 d-none">
                        <button onclick="selectAllPhotos()" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-check-double"></i> Todas
                        </button>
                        <button onclick="downloadSelectedPhotos()" class="btn btn-sm btn-success">
                            <i class="fas fa-download"></i> Download
                        </button>
                        <button onclick="showCopyMoveModal()" class="btn btn-sm btn-primary">
                            <i class="fas fa-folder"></i> Copiar/Mover
                        </button>
                        <button onclick="cancelPhotoSelectMode()" class="btn btn-sm btn-outline-danger">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <p class="text-secondary mb-3 small">
                    <i class="fas fa-info-circle"></i> Clique no <strong>X vermelho</strong> para marcar "Não é essa pessoa". O <strong>quadrado verde</strong> indica o rosto desta pessoa.
                </p>
                <div id="personPhotosGrid" class="row g-3">
                    <div class="loading-container">
                        <div class="spinner-border" role="status"></div>
                    </div>
                </div>
                <div id="personPhotosStatus" class="text-center text-secondary small py-2 d-none"></div>
                <div id="personPhotosSentinel" class="text-center text-secondary small py-2 d-none">
                    <div class="spinner-border spinner-border-sm me-2"></div>
                    Carregando mais fotos...
                </div>
                <div id="personPhotosEnd" class="text-center text-secondary small py-2 d-none">
                    <i class="fas fa-check-circle"></i> Fim da lista
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Copy/Move Modal -->
<div class="modal fade" id="copyMoveModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-folder"></i> Copiar/Mover Fotos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label" for="modeCopyPhotos">Operação:</label>
                    <div class="d-flex gap-3">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="copyMoveMode" id="modeCopyPhotos" value="copy" checked>
                            <label class="form-check-label text-body" for="modeCopyPhotos"><i class="fas fa-copy text-primary"></i> Copiar</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="copyMoveMode" id="modeMovePhotos" value="move">
                            <label class="form-check-label text-body" for="modeMovePhotos"><i class="fas fa-arrows-alt text-warning"></i> Mover</label>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label" for="destinationFolder">Pasta de destino:</label>
                    <select id="destinationFolder" class="form-select">
                        <option value="">Carregando...</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label" for="newFolderName">Ou criar nova pasta:</label>
                    <input type="text" id="newFolderName" class="form-control" placeholder="Ex: Familia/Ferias2024">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="executeCopyMove()">
                    <i class="fas fa-check"></i> Executar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Scan Context Menu -->
<div id="scanContextMenu" class="scan-context-menu d-none">
    <button onclick="pauseScan()" id="ctxPause"><i class="fas fa-pause"></i> Pausar</button>
    <button onclick="resumeScan()" id="ctxResume" class="d-none"><i class="fas fa-play"></i> Continuar</button>
    <button onclick="stopScan()" id="ctxStop"><i class="fas fa-stop"></i> Parar</button>
</div>

<!-- Photo Viewer Modal -->
<div class="modal fade" id="photoViewerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content" style="background: rgba(0,0,0,0.95);">
            <div class="modal-header border-0 position-absolute w-100 d-flex justify-content-between align-items-center px-3" style="z-index: 10;">
                <span id="photoViewerTitle" class="text-white"></span>
                <div class="d-flex gap-2 align-items-center">
                    <button type="button" class="btn btn-outline-light btn-sm" onclick="togglePhotoDetails()" title="Mostrar detalhes">
                        <i class="fas fa-info-circle"></i> Detalhes
                    </button>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
            </div>
            <div class="modal-body d-flex p-0 position-relative">
                <!-- Photo Area -->
                <div class="flex-grow-1 d-flex align-items-center justify-content-center position-relative">
                    <button class="btn btn-dark position-absolute start-0 ms-3 photo-nav-btn" onclick="viewerPrev()" style="z-index: 10; font-size: 2rem; padding: 1rem;">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <img id="photoViewerImg" src="" style="max-width: 95vw; max-height: 95vh; object-fit: contain;">
                    <button class="btn btn-dark position-absolute end-0 me-3 photo-nav-btn" onclick="viewerNext()" style="z-index: 10; font-size: 2rem; padding: 1rem;">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <!-- Details Panel (hidden by default) -->
                <div id="photoDetailsPanel" class="bg-dark text-white p-3 d-none" style="width: 350px; max-height: 100vh; overflow-y: auto; border-left: 1px solid #444;">
                    <h6 class="mb-3"><i class="fas fa-info-circle"></i> Detalhes da Foto</h6>
                    <div id="photoDetailsContent">
                        <div class="text-center py-4">
                            <div class="spinner-border spinner-border-sm text-light"></div>
                            <p class="small mt-2 mb-0">Carregando...</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 position-absolute bottom-0 w-100 justify-content-center" style="z-index: 10;">
                <span id="photoViewerCounter" class="text-white small"></span>
            </div>
        </div>
    </div>
</div>

<!-- All Photos Modal -->
<div class="modal fade" id="allPhotosModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="allPhotosModalTitle"><i class="fas fa-images"></i> Todas as Fotos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-2">
                <div class="d-flex justify-content-between align-items-center mb-2 px-2">
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-primary active" onclick="loadAllPhotosGrid('all')" id="btnFilterAll">
                            <i class="fas fa-images"></i> Todas
                        </button>
                        <button type="button" class="btn btn-outline-primary" onclick="loadAllPhotosGrid('faces')" id="btnFilterFaces">
                            <i class="fas fa-user-circle"></i> Com Rostos
                        </button>
                    </div>
                    <span class="text-muted small"><span id="allPhotosCount">0</span> fotos</span>
                </div>
                <div id="allPhotosGrid" class="all-photos-grid">
                    <div class="text-center py-5 w-100">
                        <div class="spinner-border"></div>
                        <p class="mt-2">Carregando fotos...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Capture Folder Modal -->
<div class="modal fade" id="captureFolderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-folder"></i> Selecionar pasta de Capturas</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="captureBreadcrumb" class="mb-3"></div>
                <div id="captureFolderList" class="folder-list mb-3">
                    <div class="text-center text-secondary py-3"><i class="fas fa-spinner fa-spin"></i> Carregando...</div>
                </div>
                <div class="input-group">
                    <input type="text" class="form-control" id="captureFolderName" placeholder="Nova pasta">
                    <button class="btn btn-outline-primary" type="button" onclick="createCaptureFolder()"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <div class="modal-footer d-flex justify-content-between">
                <small class="text-secondary" id="captureCurrentPath"></small>
                <button type="button" class="btn btn-primary" onclick="selectCaptureFolder()">
                    <i class="fas fa-check"></i> Selecionar esta pasta
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Scan Folder Modal -->
<div class="modal fade" id="scanFolderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-folder"></i> Selecionar pastas para scan</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="scanBreadcrumb" class="mb-3"></div>
                <div id="scanFolderList" class="folder-list mb-3">
                    <div class="text-center text-secondary py-3"><i class="fas fa-spinner fa-spin"></i> Carregando...</div>
                </div>
                <div class="text-secondary small">Marque as pastas desejadas e clique em "Adicionar selecionadas".</div>
            </div>
            <div class="modal-footer d-flex justify-content-between">
                <small class="text-secondary" id="scanCurrentPath"></small>
                <button type="button" class="btn btn-primary" onclick="addScanFolders()">
                    <i class="fas fa-check"></i> Adicionar selecionadas
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Camera Modal -->
<div class="modal fade" id="cameraModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-video"></i> Câmera RTSP</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label" for="cameraName">Nome</label>
                        <input type="text" class="form-control" id="cameraName" placeholder="Ex: Garagem, Sala">
                    </div>
                    <div class="col-12">
                        <label class="form-label" for="cameraRtspUrl">URL RTSP</label>
                        <input type="text" class="form-control" id="cameraRtspUrl" placeholder="rtsp://172.16.0.177/V_ENC_001">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="cameraUsername">Usuário</label>
                        <input type="text" class="form-control" id="cameraUsername" placeholder="admin">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="cameraPassword">Senha</label>
                        <input type="password" class="form-control" id="cameraPassword" placeholder="senha">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="cameraQuality">Qualidade</label>
                        <select class="form-select" id="cameraQuality">
                            <option value="auto">Automatica</option>
                            <option value="360p">Baixa (640x360)</option>
                            <option value="480p">Media (854x480)</option>
                            <option value="720p">Alta (1280x720)</option>
                            <option value="1080p">Ultra (1920x1080)</option>
                        </select>
                    </div>
                    <div class="col-md-6 d-flex align-items-end">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="cameraLowLatency" checked>
                            <label class="form-check-label" for="cameraLowLatency">Baixa latencia</label>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="cameraBackendEnabled">
                            <label class="form-check-label" for="cameraBackendEnabled">Processar em segundo plano (backend)</label>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="cameraCaptureEnabled">
                            <label class="form-check-label" for="cameraCaptureEnabled">Capturar reconhecimentos (incluindo desconhecidos)</label>
                        </div>
                    </div>
                    <div class="col-12">
                        <label class="form-label" for="cameraCaptureLocation">Local de captura</label>
                        <select class="form-select" id="cameraCaptureLocation" onchange="toggleCameraCapturePath()">
                            <option value="data">Padrão: /mnt/Capturas</option>
                            <option value="custom">Personalizado (diretório base)</option>
                        </select>
                        <div class="input-group mt-2 d-none" id="cameraCapturePathGroup">
                            <input type="text" class="form-control" id="cameraCapturePath" placeholder="/mnt/Capturas" readonly>
                            <button class="btn btn-outline-secondary" type="button" onclick="openCaptureFolderModal()">
                                <i class="fas fa-folder-open"></i>
                            </button>
                        </div>
                        <small class="text-secondary d-block mt-1">Será criada a pasta <strong>PhotoRecognition/Capturas</strong> dentro do diretório selecionado.</small>
                    </div>
                </div>
                <div class="border-top mt-3 pt-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong>Pré-teste</strong>
                        <button class="btn btn-sm btn-outline-primary" type="button" id="cameraTestBtn" onclick="testCamera()"><i class="fas fa-vial"></i> Testar</button>
                    </div>
                    <div id="cameraTestStatus" class="text-secondary small">Nenhum teste executado.</div>
                    <div id="cameraTestPreview" class="mt-2"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveCamera()"><i class="fas fa-save"></i> Salvar</button>
            </div>
        </div>
    </div>
</div>

<!-- Capture Log Modal -->
<div class="modal fade" id="captureLogModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-camera"></i> Capturas Recentes</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="captureLogList" class="capture-log-list">
                    <div class="text-center text-secondary py-3"><i class="fas fa-spinner fa-spin"></i> Carregando...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Group Modal -->
<div class="modal fade" id="groupModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="groupModalTitle"><i class="fas fa-folder-plus"></i> Novo Grupo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="groupEditId">
                <div class="mb-3">
                    <label for="groupName" class="form-label">Nome do Grupo</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="groupName" placeholder="Ex: Familia, Amigos, Trabalho">
                    </div>
                </div>
                    <div class="mb-3">
                        <label class="form-label">Cor do Grupo</label>
                        <div class="d-flex gap-2 flex-wrap" id="groupColorPicker" role="group" aria-label="Seletor de cor do grupo">
                            <button type="button" class="btn btn-sm color-pick" data-color="#dc3545" style="background:#dc3545;width:32px;height:32px;border-radius:50%;border:2px solid transparent;"></button>
                            <button type="button" class="btn btn-sm color-pick" data-color="#fd7e14" style="background:#fd7e14;width:32px;height:32px;border-radius:50%;border:2px solid transparent;"></button>
                            <button type="button" class="btn btn-sm color-pick" data-color="#ffc107" style="background:#ffc107;width:32px;height:32px;border-radius:50%;border:2px solid transparent;"></button>
                            <button type="button" class="btn btn-sm color-pick" data-color="#198754" style="background:#198754;width:32px;height:32px;border-radius:50%;border:2px solid transparent;"></button>
                            <button type="button" class="btn btn-sm color-pick" data-color="#0dcaf0" style="background:#0dcaf0;width:32px;height:32px;border-radius:50%;border:2px solid transparent;"></button>
                            <button type="button" class="btn btn-sm color-pick" data-color="#0d6efd" style="background:#0d6efd;width:32px;height:32px;border-radius:50%;border:2px solid transparent;"></button>
                            <button type="button" class="btn btn-sm color-pick" data-color="#6f42c1" style="background:#6f42c1;width:32px;height:32px;border-radius:50%;border:2px solid transparent;"></button>
                            <button type="button" class="btn btn-sm color-pick" data-color="#d63384" style="background:#d63384;width:32px;height:32px;border-radius:50%;border:2px solid transparent;"></button>
                        </div>
                        <input type="hidden" id="groupColor" value="#0d6efd">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ícone do Grupo</label>
                        <div class="d-flex gap-2 flex-wrap" id="groupIconPicker" role="group" aria-label="Seletor de ícone do grupo">
                            <button type="button" class="btn btn-sm icon-pick" data-icon="fas fa-users"><i class="fas fa-users"></i></button>
                            <button type="button" class="btn btn-sm icon-pick" data-icon="fas fa-user-friends"><i class="fas fa-user-friends"></i></button>
                            <button type="button" class="btn btn-sm icon-pick" data-icon="fas fa-home"><i class="fas fa-home"></i></button>
                            <button type="button" class="btn btn-sm icon-pick" data-icon="fas fa-briefcase"><i class="fas fa-briefcase"></i></button>
                            <button type="button" class="btn btn-sm icon-pick" data-icon="fas fa-heart"><i class="fas fa-heart"></i></button>
                            <button type="button" class="btn btn-sm icon-pick" data-icon="fas fa-star"><i class="fas fa-star"></i></button>
                            <button type="button" class="btn btn-sm icon-pick" data-icon="fas fa-camera"><i class="fas fa-camera"></i></button>
                            <button type="button" class="btn btn-sm icon-pick" data-icon="fas fa-plane"><i class="fas fa-plane"></i></button>
                            <button type="button" class="btn btn-sm icon-pick" data-icon="fas fa-graduation-cap"><i class="fas fa-graduation-cap"></i></button>
                            <button type="button" class="btn btn-sm icon-pick" data-icon="fas fa-paw"><i class="fas fa-paw"></i></button>
                            <button type="button" class="btn btn-sm icon-pick" data-icon="fas fa-baby"><i class="fas fa-baby"></i></button>
                            <button type="button" class="btn btn-sm icon-pick" data-icon="fas fa-globe"><i class="fas fa-globe"></i></button>
                        </div>
                        <input type="hidden" id="groupIcon" value="">
                    </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger d-none" id="btnDeleteGroup" onclick="deleteGroup()">
                    <i class="fas fa-trash"></i> Excluir
                </button>
                <button type="button" class="btn btn-primary" onclick="saveGroup()">
                    <i class="fas fa-save"></i> Salvar
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let photoModal, personModal, welcomeModal, copyMoveModal, photoViewerModal, groupModal, allPhotosModal, captureFolderModal, scanFolderModal, cameraModal, captureLogModal;
        let currentPersonId = null;
        let markerResizeTimeout = null;
        let markerCacheSaveTimeout = null;
        const markerCache = new Map();
        const MARKER_CACHE_LIMIT = 800;
        const MARKER_CACHE_KEY = 'markerCacheV1';
        let mergeMode = false;

    let groups = [];
    let selectedPersons = [];
    let photoSelectMode = false;
    let selectedPhotos = [];  // Array of {photo_id, face_id}
    let currentPersonPhotos = [];  // All photos of current person
    let personPhotosOffset = 0;
    let personPhotosHasMore = false;
    let personPhotosLoading = false;
    let personPhotosObserver = null;
    let personPhotosTotal = 0;
    let savedCameras = [];
    let editingCameraId = null;
    let captureBrowsePath = '/mnt/Capturas';
    let cameraPreviewActive = false;
    let captureFooterItems = [];
    let selectedScanFolders = [];
    let scanBrowsePath = '/mnt/photos';
    let folderSelectionContext = 'capture';
    let recognitionHistory = [];
    let showFaceMarkers = true;  // Toggle for face markers visibility
    let viewerPhotos = [];  // Array of photo paths for viewer navigation
    let viewerIndex = 0;  // Current index in viewer
    let scanPaused = false;  // Track scan pause state
    let lastScanStatus = 'Idle';  // Track previous scan status for detecting completion

    document.addEventListener('DOMContentLoaded', () => {
        photoModal = new bootstrap.Modal(document.getElementById('photoModal'));
        personModal = new bootstrap.Modal(document.getElementById('personModal'));
        welcomeModal = new bootstrap.Modal(document.getElementById('welcomeModal'));
        copyMoveModal = new bootstrap.Modal(document.getElementById('copyMoveModal'));
        photoViewerModal = new bootstrap.Modal(document.getElementById('photoViewerModal'));
        groupModal = new bootstrap.Modal(document.getElementById('groupModal'));
        allPhotosModal = new bootstrap.Modal(document.getElementById('allPhotosModal'));
        captureFolderModal = new bootstrap.Modal(document.getElementById('captureFolderModal'));
        scanFolderModal = new bootstrap.Modal(document.getElementById('scanFolderModal'));
        cameraModal = new bootstrap.Modal(document.getElementById('cameraModal'));
        captureLogModal = new bootstrap.Modal(document.getElementById('captureLogModal'));

        document.getElementById('cameraModal').addEventListener('hidden.bs.modal', () => {
            stopCameraPreview();
        });

        const captureModalEl = document.getElementById('captureFolderModal');
        captureModalEl.addEventListener('shown.bs.modal', () => {
            const backdrops = document.querySelectorAll('.modal-backdrop');
            const last = backdrops[backdrops.length - 1];
            if (last) {
                last.classList.add('capture-folder-backdrop');
            }
        });
        captureModalEl.addEventListener('hidden.bs.modal', () => {
            document.querySelectorAll('.modal-backdrop.capture-folder-backdrop').forEach(el => el.classList.remove('capture-folder-backdrop'));
        });

        // Load Bing daily background
        loadBingBackground();

        // Load saved visual settings
        loadVisualSettings();

        // Color picker for groups
        document.querySelectorAll('.color-pick').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.color-pick').forEach(b => b.style.borderColor = 'transparent');
                btn.style.borderColor = 'white';
                document.getElementById('groupColor').value = btn.dataset.color;
            });
        });

        // Icon picker for groups
        document.querySelectorAll('.icon-pick').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.icon-pick').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                document.getElementById('groupIcon').value = btn.dataset.icon;
            });
        });

        // Load persons on start (fetchPersonsData already loads groups)
        loadPersons();

        // Load saved cameras
        loadSavedCameras();
        toggleCameraCapturePath();

        refreshCaptureFooter();
        refreshCaptureFooterDetails();
        setInterval(refreshCaptureFooter, 5000);
        setInterval(refreshCaptureFooterDetails, 12000);

        const captureFooter = document.getElementById('captureFooter');
        if (captureFooter) {
            captureFooter.addEventListener('mouseenter', refreshCaptureFooterDetails);
            captureFooter.addEventListener('click', openCaptureLogModal);
        }

        loadFolders();



        const liveSource = document.getElementById('liveVideoSource');
        if (liveSource) {
            liveSource.addEventListener('change', function() {
                const customDiv = document.getElementById('liveCustomRtspDiv');
                const onvifFields = document.getElementById('liveOnvifCredentials');
                const isCustom = this.value === 'custom';
                const isWebcam = this.value === 'webcam';
                const isSaved = this.value.startsWith('saved:');

                customDiv.classList.toggle('d-none', !isCustom);
                onvifFields.classList.toggle('d-none', isWebcam || isSaved);
            });
        }

        // Keyboard navigation for photo viewer
        document.addEventListener('keydown', (e) => {
            const viewerEl = document.getElementById('photoViewerModal');
            if (!viewerEl.classList.contains('show')) return;
            if (e.key === 'ArrowLeft') viewerPrev();
            else if (e.key === 'ArrowRight') viewerNext();
            else if (e.key === 'Escape') photoViewerModal.hide();
        });

        loadMarkerCache();

        window.addEventListener('resize', () => {
            if (!personModal?._isShown) return;
            clearTimeout(markerResizeTimeout);
            markerResizeTimeout = setTimeout(() => {
                if (currentPersonId) openPersonModal(currentPersonId);
            }, 300);
        });

        // Right-click context menu for scan status
        document.getElementById('sysState').addEventListener('contextmenu', (e) => {
            if (!e.target.classList.contains('scanning')) return;
            e.preventDefault();
            const menu = document.getElementById('scanContextMenu');
            menu.classList.remove('d-none');
            menu.style.left = e.pageX + 'px';
            menu.style.top = e.pageY + 'px';
            // Update button visibility based on pause state
            document.getElementById('ctxPause').classList.toggle('d-none', scanPaused);
            document.getElementById('ctxResume').classList.toggle('d-none', !scanPaused);
        });

        // Close context menu on click outside
        document.addEventListener('click', () => {
            document.getElementById('scanContextMenu').classList.add('d-none');
        });

        // Initialize infinite scroll observer for person photos
        initPersonPhotosObserver();

        // Reset selection mode when person modal closes
        document.getElementById('personModal').addEventListener('hidden.bs.modal', () => {
            cancelPhotoSelectMode();
            const sentinel = document.getElementById('personPhotosSentinel');
            const status = document.getElementById('personPhotosStatus');
            const endMsg = document.getElementById('personPhotosEnd');
            if (personPhotosObserver && sentinel) {
                personPhotosObserver.unobserve(sentinel);
            }
            personPhotosOffset = 0;
            personPhotosHasMore = false;
            personPhotosLoading = false;
            personPhotosTotal = 0;
            currentPersonPhotos = [];
            if (status) {
                status.classList.add('d-none');
                status.textContent = '';
            }
            if (endMsg) {
                endMsg.classList.add('d-none');
            }
        });

        // Check if first use
        checkFirstUse();
        updateStats();
    });

    setInterval(updateStats, 5000);

    async function checkFirstUse() {
        try {
            const res = await fetch('/stats');
            const data = await res.json();

            // Show welcome modal if no photos indexed
            if (data.photos_indexed === 0) {
                loadWelcomeFolders();
                welcomeModal.show();
            }
        } catch (e) {
            console.error(e);
        }
    }

    async function loadWelcomeFolders() {
        renderWelcomeFolderList();
    }

    async function startInitialScan() {
        const selected = [...selectedScanFolders];

        if (selected.length === 0) {
            if (!confirm('Nenhuma pasta selecionada. Escanear TUDO?')) {
                return;
            }
        }

        welcomeModal.hide();

        await fetch('/scan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ folders: selected })
        });

        alert('Scan iniciado! Acompanhe o progresso no rodapé.');
        updateStats();
    }

    function skipWelcome() {
        welcomeModal.hide();
    }

    // ==================== BING BACKGROUND & TRANSPARENCY ====================

    async function loadBingBackground() {
        try {
            // Fetch Bing daily image URL from our backend proxy
            const res = await fetch('/bing-background');
            const data = await res.json();

            if (data.url) {
                // Preload image
                const img = new Image();
                img.onload = () => {
                    document.body.classList.add('has-bg');
                    // Set the background-image on body::before via a style tag
                    let styleEl = document.getElementById('bing-bg-style');
                    if (!styleEl) {
                        styleEl = document.createElement('style');
                        styleEl.id = 'bing-bg-style';
                        document.head.appendChild(styleEl);
                    }
                    styleEl.textContent = `body::before { background-image: url('${data.url}'); }`;
                };
                img.onerror = () => {
                    console.log('Could not load Bing background image');
                };
                img.src = data.url;
            }
        } catch (e) {
            console.log('Error loading Bing background:', e);
        }
    }

    function updateTransparency(value) {
        const opacity = 1 - (value / 100);
        document.documentElement.style.setProperty('--card-opacity', opacity);

        // Update both sliders and labels
        const headerSlider = document.getElementById('transparencySlider');
        const headerValue = document.getElementById('transparencyValue');
        const settingsSlider = document.getElementById('settingsTransparency');
        const settingsValue = document.getElementById('settingsTransparencyValue');

        if (headerSlider) headerSlider.value = value;
        if (headerValue) headerValue.textContent = value + '%';
        if (settingsSlider) settingsSlider.value = value;
        if (settingsValue) settingsValue.textContent = value + '%';

        localStorage.setItem('cardTransparency', value);
    }

    function updateFaceSize(value) {
        const cardSize = Math.round(value * 1.25); // Card is 25% larger than face
        document.documentElement.style.setProperty('--face-size', value + 'px');
        document.documentElement.style.setProperty('--card-size', cardSize + 'px');

        const slider = document.getElementById('settingsFaceSize');
        const valueLabel = document.getElementById('settingsFaceSizeValue');

        if (slider) slider.value = value;
        if (valueLabel) valueLabel.textContent = value + 'px';

        localStorage.setItem('faceSize', value);
    }

    function resetVisualSettings() {
        updateTransparency(0);
        updateFaceSize(80);
    }

    function loadVisualSettings() {
        const savedTransparency = localStorage.getItem('cardTransparency') || '0';
        const savedFaceSize = localStorage.getItem('faceSize') || '80';

        updateTransparency(savedTransparency);
        updateFaceSize(savedFaceSize);
        loadCacheSettings();
        loadOnvifSettings();
    }

    function loadCacheSettings() {
        const savedLimit = localStorage.getItem('personPhotoLimit') || '30';
        const savedPreload = localStorage.getItem('preloadCount') || '6';
        const savedCacheMax = localStorage.getItem('cacheMaxGB') || '10';
        const savedWebpQuality = localStorage.getItem('webpQuality') || '70';

        document.getElementById('settingsPersonPhotoLimit').value = savedLimit;
        document.getElementById('settingsPreloadCount').value = savedPreload;
        document.getElementById('settingsCacheMax').value = savedCacheMax;
        document.getElementById('settingsWebpQuality').value = savedWebpQuality;

        applyCacheSettings({
            personPhotoLimit: parseInt(savedLimit, 10),
            preloadCount: parseInt(savedPreload, 10),
            cacheMaxGB: parseFloat(savedCacheMax),
            webpQuality: parseInt(savedWebpQuality, 10)
        });
    }

    function saveCacheSettings() {
        const personPhotoLimit = parseInt(document.getElementById('settingsPersonPhotoLimit').value, 10);
        const preloadCount = parseInt(document.getElementById('settingsPreloadCount').value, 10);
        const cacheMaxGB = parseFloat(document.getElementById('settingsCacheMax').value);
        const webpQuality = parseInt(document.getElementById('settingsWebpQuality').value, 10);

        localStorage.setItem('personPhotoLimit', personPhotoLimit.toString());
        localStorage.setItem('preloadCount', preloadCount.toString());
        localStorage.setItem('cacheMaxGB', cacheMaxGB.toString());
        localStorage.setItem('webpQuality', webpQuality.toString());

        applyCacheSettings({ personPhotoLimit, preloadCount, cacheMaxGB, webpQuality });
        syncCacheSettingsToServer(cacheMaxGB, webpQuality);
        applyPersonPhotoLimit();
    }

    function applyCacheSettings({ personPhotoLimit, preloadCount, cacheMaxGB, webpQuality }) {
        window.cacheSettings = {
            personPhotoLimit,
            preloadCount,
            cacheMaxGB,
            webpQuality
        };
        applyPersonPhotoLimit();
    }

    function applyPersonPhotoLimit() {
        if (currentPersonId && personModal?._isShown) {
            openPersonModal(currentPersonId);
        }
    }

    async function syncCacheSettingsToServer(cacheMaxGB, webpQuality) {
        try {
            await fetch('/cache/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ max_cache_gb: cacheMaxGB, webp_quality: webpQuality })
            });
        } catch (e) {
            console.error('Erro ao salvar configuracoes de cache', e);
        }
    }

    async function updateStats() {
        try {
            const res = await fetch('/stats');
            const data = await res.json();
            document.getElementById('statPhotos').innerText = data.photos_indexed;
            document.getElementById('statFaces').innerText = data.faces_indexed;
            document.getElementById('statPersons').innerText = data.persons_identified || 0;
            document.getElementById('sysDetail').innerText = data.current_detail || 'Sistema pronto';

            const stateBadge = document.getElementById('sysState');
            if (data.status === 'Idle') {
                stateBadge.className = 'status-badge idle';
                stateBadge.innerHTML = '<i class="fas fa-circle"></i> Idle';

                // Check if scan just finished (was scanning, now idle)
                if (lastScanStatus === 'Scanning' && data.faces_indexed > 0) {
                    checkSuggestionsAfterScan();
                }
                scanPaused = false;
            } else if (data.status === 'Paused') {
                stateBadge.className = 'status-badge scanning';
                stateBadge.innerHTML = '<i class="fas fa-pause"></i> Pausado';
                scanPaused = true;
            } else {
                stateBadge.className = 'status-badge scanning';
                stateBadge.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ' + data.status;
                scanPaused = false;
            }
            lastScanStatus = data.status;
        } catch (e) { console.error("Erro stats", e); }
    }

    async function checkSuggestionsAfterScan() {
        try {
            const res = await fetch('/persons/suggestions?threshold=0.55');
            const data = await res.json();

            if (data.suggestions && data.suggestions.length > 0) {
                // Show notification about suggestions
                const count = data.suggestions.length;
                if (confirm(`Scan concluído! Foram encontradas ${count} sugestão(ões) de mesclagem.\n\nDeseja visualizar?`)) {
                    // Navigate to persons tab and show suggestions
                    const personsTab = document.querySelector('#persons-tab');
                    if (personsTab) {
                        personsTab.click();
                        setTimeout(() => {
                            showMergeSuggestions();
                            loadPersons();
                        }, 300);
                    }
                } else {
                    loadPersons();  // Just reload persons list
                }
            } else {
                loadPersons();  // Reload persons list
            }
        } catch (e) {
            console.error('Error checking suggestions:', e);
            loadPersons();
        }
    }

    // ==================== MERGE SUGGESTIONS ====================

    async function showMergeSuggestions() {
        const container = document.getElementById('suggestionsContainer');
        const list = document.getElementById('suggestionsList');

        container.classList.remove('d-none');
        list.innerHTML = '<div class="text-center py-3"><i class="fas fa-spinner fa-spin"></i> Analisando...</div>';

        try {
            const res = await fetch('/persons/suggestions?threshold=0.55');
            if (!res.ok) {
                throw new Error(`HTTP error: ${res.status}`);
            }
            const data = await res.json();

            if (!data.suggestions || data.suggestions.length === 0) {
                list.innerHTML = '<div class="alert alert-info"><i class="fas fa-check-circle"></i> Nenhuma sugestão encontrada. Todas as pessoas parecem estar corretamente separadas.</div>';
                return;
            }

            list.innerHTML = data.suggestions.map(s => {
                // Safely get values with defaults
                const person1 = s.person1 || {};
                const person2 = s.person2 || {};
            const img1 = person1.rep_face_id ? buildFaceThumbUrl(person1.rep_face_id) : 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%23ddd"/></svg>';
            const img2 = person2.rep_face_id ? buildFaceThumbUrl(person2.rep_face_id) : 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%23ddd"/></svg>';

                const name1 = (person1.name || 'Pessoa ' + person1.id).replace(/'/g, "\\'");
                const name2 = (person2.name || 'Pessoa ' + person2.id).replace(/'/g, "\\'");

                return `
                    <div class="suggestion-card">
                        <div class="person-pair">
                            <div class="person-mini">
                                <img src="${img1}" alt="${name1}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2250%22 fill=%22%23ddd%22/></svg>'">
                                <div class="name">${name1}</div>
                            </div>
                            <span class="arrow"><i class="fas fa-arrows-alt-h"></i></span>
                            <div class="person-mini">
                                <img src="${img2}" alt="${name2}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2250%22 fill=%22%23ddd%22/></svg>'">
                                <div class="name">${name2}</div>
                            </div>
                        </div>
                        <span class="similarity">${s.similarity || 0}%</span>
                        <button class="btn btn-sm btn-success" onclick="quickMerge(${person1.id}, ${person2.id}, '${name1}', '${name2}')">
                            <i class="fas fa-compress-arrows-alt"></i> Mesclar
                        </button>
                    </div>
                `;
            }).join('');
        } catch (e) {
            console.error('Error loading suggestions:', e);
            list.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> Erro ao carregar sugestões. Tente novamente.</div>';
        }
    }

    function hideSuggestions() {
        document.getElementById('suggestionsContainer').classList.add('d-none');
    }

    function toggleFaceMarkersVisibility() {
        showFaceMarkers = document.getElementById('showFaceMarkers').checked;
        // Toggle visibility of all existing face markers
        document.querySelectorAll('.face-marker').forEach(marker => {
            marker.style.display = showFaceMarkers ? 'block' : 'none';
        });
    }

    // ==================== PHOTO VIEWER ====================

    function openPhotoViewer(photos, startIndex) {
        viewerPhotos = photos;
        viewerIndex = startIndex || 0;
        
        // Reset details panel state
        photoDetailsVisible = false;
        const panel = document.getElementById('photoDetailsPanel');
        panel.classList.add('d-none');
        panel.classList.remove('show');
        
        updateViewer();
        photoViewerModal.show();
    }

    function updateViewer() {
        if (viewerPhotos.length === 0) return;
        const photo = viewerPhotos[viewerIndex];
        document.getElementById('photoViewerImg').src = photo.path;
        document.getElementById('photoViewerTitle').textContent = photo.filename || '';
        document.getElementById('photoViewerCounter').textContent = `${viewerIndex + 1} / ${viewerPhotos.length}`;
        preloadViewerImages(viewerIndex);
        preloadViewerThumbs(viewerIndex);
        
        // Refresh details if panel is open
        if (photoDetailsVisible) {
            loadPhotoDetails();
        }
    }


    function viewerPrev() {
        if (viewerPhotos.length === 0) return;
        viewerIndex = (viewerIndex - 1 + viewerPhotos.length) % viewerPhotos.length;
        updateViewer();
    }

    function viewerNext() {
        if (viewerPhotos.length === 0) return;
        viewerIndex = (viewerIndex + 1) % viewerPhotos.length;
        updateViewer();
    }

    // ==================== PHOTO DETAILS ====================

    let photoDetailsVisible = false;

    function togglePhotoDetails() {
        const panel = document.getElementById('photoDetailsPanel');
        photoDetailsVisible = !photoDetailsVisible;
        
        if (photoDetailsVisible) {
            panel.classList.remove('d-none');
            panel.classList.add('show');
            loadPhotoDetails();
        } else {
            panel.classList.add('d-none');
            panel.classList.remove('show');
        }
    }

    async function loadPhotoDetails() {
        const content = document.getElementById('photoDetailsContent');
        if (viewerPhotos.length === 0) {
            content.innerHTML = '<p class="text-secondary small">Nenhuma foto</p>';
            return;
        }
        
        const photo = viewerPhotos[viewerIndex];
        console.log('Loading details for photo:', photo);
        
        if (!photo || !photo.photo_id) {
            content.innerHTML = '<p class="text-secondary small">Detalhes não disponíveis (sem ID)</p>';
            return;
        }
        
        content.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border spinner-border-sm text-light"></div>
                <p class="small mt-2 mb-0">Carregando...</p>
            </div>
        `;
        
        try {
            const url = `/photo/${photo.photo_id}/details`;
            console.log('Fetching:', url);
            const res = await fetch(url);
            
            if (!res.ok) {
                const errText = await res.text();
                console.error('API Error:', res.status, errText);
                content.innerHTML = `<p class="text-danger small">Erro ${res.status}</p>`;
                return;
            }
            
            const details = await res.json();
            console.log('Details received:', details);
            renderPhotoDetails(details);
        } catch (e) {
            console.error('Error loading photo details:', e);
            content.innerHTML = `<p class="text-danger small">Erro: ${e.message}</p>`;
        }
    }

    function renderPhotoDetails(details) {
        const content = document.getElementById('photoDetailsContent');
        
        const formatDate = (dateStr) => {
            if (!dateStr) return null;
            const d = new Date(dateStr);
            return d.toLocaleDateString('pt-BR') + ' ' + d.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
        };
        
        const createDetailItem = (label, value, searchType = null, searchValue = null) => {
            if (!value) return '';
            const clickable = searchType ? 'clickable' : '';
            // Escape special characters for safe onclick attribute
            const escapeAttr = (str) => {
                if (!str) return '';
                return String(str)
                    .replace(/&/g, '&amp;')
                    .replace(/'/g, '&#39;')
                    .replace(/"/g, '&quot;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
            };
            const searchVal = escapeAttr(searchValue || value);
            const onclick = searchType ? `onclick="searchByDetail('${searchType}', '${searchVal}')"`  : '';
            return `
                <div class="photo-detail-item">
                    <span class="photo-detail-label">${label}</span>
                    <span class="photo-detail-value ${clickable}" ${onclick}>${value}</span>
                </div>
            `;
        };
        
        let html = '';
        
        // Basic Info
        html += createDetailItem('Arquivo', details.filename);
        html += createDetailItem('Pasta', details.folder || 'Raiz', 'folder', details.folder);
        html += createDetailItem('Tamanho', details.file_size_human);
        html += createDetailItem('Dimensões', details.width && details.height ? `${details.width} x ${details.height}` : null);
        html += createDetailItem('Formato', details.format);
        html += createDetailItem('Rostos', details.face_count > 0 ? `${details.face_count} detectado(s)` : 'Nenhum');
        
        // Date Info
        if (details.capture_date || details.modified_date) {
            html += `<div class="photo-detail-section"><h6><i class="fas fa-calendar"></i> Datas</h6></div>`;
            if (details.capture_date) {
                const dateOnly = details.capture_date.split('T')[0];
                html += createDetailItem('Captura', formatDate(details.capture_date), 'date', dateOnly);
            }
            html += createDetailItem('Modificado', formatDate(details.modified_date));
            html += createDetailItem('Adicionado', formatDate(details.added_at));
        }
        
        // Camera Info
        if (details.camera_make || details.camera_model || details.lens) {
            html += `<div class="photo-detail-section"><h6><i class="fas fa-camera"></i> Câmera</h6></div>`;
            html += createDetailItem('Fabricante', details.camera_make, 'camera_make', details.camera_make);
            html += createDetailItem('Modelo', details.camera_model, 'camera_model', details.camera_model);
            html += createDetailItem('Lente', details.lens);
        }
        
        // Technical Info
        if (details.focal_length || details.aperture || details.iso || details.exposure) {
            html += `<div class="photo-detail-section"><h6><i class="fas fa-sliders-h"></i> Configurações</h6></div>`;
            html += createDetailItem('Focal', details.focal_length);
            html += createDetailItem('Abertura', details.aperture);
            html += createDetailItem('ISO', details.iso, 'iso', details.iso);
            html += createDetailItem('Exposição', details.exposure);
            html += createDetailItem('Flash', details.flash);
        }
        
        // Software
        if (details.software) {
            html += `<div class="photo-detail-section"><h6><i class="fas fa-code"></i> Software</h6></div>`;
            html += createDetailItem('Editado com', details.software);
        }
        
        // EXIF extras (collapsible)
        const exifKeys = Object.keys(details.exif || {}).filter(k => 
            !['Make', 'Model', 'LensModel', 'FocalLength', 'FNumber', 'ISOSpeedRatings', 
              'ExposureTime', 'Flash', 'Software', 'DateTimeOriginal', 'DateTime', 'GPS'].includes(k)
        );
        
        if (exifKeys.length > 0) {
            html += `
                <div class="photo-detail-section">
                    <h6 class="d-flex justify-content-between align-items-center" style="cursor: pointer;" onclick="toggleExifDetails()">
                        <span><i class="fas fa-database"></i> EXIF Completo</span>
                        <i class="fas fa-chevron-down" id="exifChevron"></i>
                    </h6>
                </div>
                <div id="exifDetailsExtra" class="d-none">
            `;
            exifKeys.slice(0, 20).forEach(key => {
                const val = details.exif[key];
                if (val && typeof val !== 'object') {
                    html += createDetailItem(key, String(val).substring(0, 50));
                }
            });
            html += '</div>';
        }
        
        content.innerHTML = html || '<p class="text-secondary small">Nenhum detalhe disponível</p>';
    }

    function toggleExifDetails() {
        const extra = document.getElementById('exifDetailsExtra');
        const chevron = document.getElementById('exifChevron');
        if (extra.classList.contains('d-none')) {
            extra.classList.remove('d-none');
            chevron.className = 'fas fa-chevron-up';
        } else {
            extra.classList.add('d-none');
            chevron.className = 'fas fa-chevron-down';
        }
    }

    async function searchByDetail(type, value) {
        // Close the viewer modal
        photoViewerModal.hide();
        
        // Show loading in results
        const resultsGrid = document.getElementById('resultsGrid');
        resultsGrid.innerHTML = '<div class="loading-container"><div class="spinner-border"></div><p>Buscando...</p></div>';
        document.getElementById('resultCount').textContent = '...';
        
        try {
            let results = [];
            
            if (type === 'folder') {
                const res = await fetch(`/search/folder?folder=${encodeURIComponent(value)}&limit=100`);
                results = await res.json();
            } else if (type === 'date') {
                // Search by date (same day)
                const res = await fetch(`/search/metadata?start_date=${value}&end_date=${value}`);
                results = await res.json();
            } else if (type === 'camera_model' || type === 'camera_make') {
                const res = await fetch(`/search/metadata?camera_model=${encodeURIComponent(value)}`);
                results = await res.json();
            } else if (type === 'iso') {
                // ISO search not directly supported, fallback
                alert(`Busca por ISO "${value}" não disponível diretamente. Use os filtros.`);
                return;
            }
            
            renderResults(results);
        } catch (e) {
            console.error('Search error:', e);
            resultsGrid.innerHTML = '<div class="empty-state text-danger"><p>Erro na busca</p></div>';
        }
    }

    async function quickMerge(id1, id2, name1, name2) {
        if (!confirm(`Mesclar "${name2}" em "${name1}"?\n\nTodas as fotos de "${name2}" serão movidas para "${name1}".`)) return;

        try {
            await fetch('/persons/merge', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ source_id: id2, target_id: id1 })
            });
            alert('Pessoas mescladas com sucesso!');
            loadPersons();
            showMergeSuggestions(); // Refresh suggestions
            updateStats();
        } catch (e) {
            console.error(e);
            alert('Erro ao mesclar.');
        }
    }

    // ==================== PERSONS ====================

    function toggleMergeMode() {
        mergeMode = !mergeMode;
        selectedPersons = [];
        document.getElementById('btnMergeMode').classList.toggle('d-none', mergeMode);
        document.getElementById('btnSuggestions').classList.toggle('d-none', mergeMode);
        document.getElementById('btnConfirmMerge').classList.toggle('d-none', !mergeMode);
        document.getElementById('btnCancelMerge').classList.toggle('d-none', !mergeMode);
        document.getElementById('mergeInstructions').classList.toggle('d-none', !mergeMode);
        loadPersons();
    }

    function cancelMergeMode() {
        mergeMode = false;
        selectedPersons = [];
        document.getElementById('btnMergeMode').classList.remove('d-none');
        document.getElementById('btnSuggestions').classList.remove('d-none');
        document.getElementById('btnConfirmMerge').classList.add('d-none');
        document.getElementById('btnCancelMerge').classList.add('d-none');
        document.getElementById('mergeInstructions').classList.add('d-none');
        loadPersons();
    }

    function togglePersonSelection(personId, element) {
        const idx = selectedPersons.indexOf(personId);
        if (idx === -1) {
            selectedPersons.push(personId);
            element.classList.add('selected');
        } else {
            selectedPersons.splice(idx, 1);
            element.classList.remove('selected');
        }
        document.getElementById('btnConfirmMerge').disabled = selectedPersons.length < 2;
    }

    async function confirmMerge() {
        if (selectedPersons.length < 2) {
            alert('Selecione pelo menos 2 pessoas para mesclar.');
            return;
        }

        const targetId = selectedPersons[0];
        const names = selectedPersons.map(id => {
            const card = document.querySelector(`[data-person-id="${id}"]`);
            return card ? card.querySelector('.person-name').innerText : `Pessoa ${id}`;
        });

        if (!confirm(`Mesclar ${names.join(', ')} em "${names[0]}"?\n\nTodas as fotos serão movidas para "${names[0]}".`)) return;

        try {
            for (let i = 1; i < selectedPersons.length; i++) {
                await fetch('/persons/merge', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ source_id: selectedPersons[i], target_id: targetId })
                });
            }
            alert('Pessoas mescladas com sucesso!');
            cancelMergeMode();
            updateStats();
        } catch (e) {
            console.error(e);
            alert('Erro ao mesclar pessoas.');
        }
    }

    // ==================== GROUPS ====================

    async function loadGroups() {
        try {
            const res = await fetch('/groups');
            groups = await res.json();
        } catch (e) {
            console.error('Error loading groups:', e);
        }
    }

    function openCreateGroupModal() {
        document.getElementById('groupModalTitle').innerHTML = '<i class="fas fa-folder-plus"></i> Novo Grupo';
        document.getElementById('groupEditId').value = '';
        document.getElementById('groupName').value = '';
        document.getElementById('groupColor').value = '#0d6efd';
        document.getElementById('groupIcon').value = 'fas fa-users';
        document.querySelectorAll('.icon-pick').forEach(b => b.classList.remove('selected'));
        const defaultIcon = document.querySelector('.icon-pick[data-icon="fas fa-users"]');
        if (defaultIcon) defaultIcon.classList.add('selected');
        document.querySelectorAll('.color-pick').forEach(b => b.style.borderColor = 'transparent');
        document.querySelector('.color-pick[data-color="#0d6efd"]').style.borderColor = 'white';
        document.querySelectorAll('.icon-pick').forEach(b => b.classList.remove('selected'));
        document.getElementById('btnDeleteGroup').classList.add('d-none');
        groupModal.show();
    }

    function openEditGroupModal(groupId) {
        const group = groups.find(g => g.id === groupId);
        if (!group) return;

        document.getElementById('groupModalTitle').innerHTML = '<i class="fas fa-folder"></i> Editar Grupo';
        document.getElementById('groupEditId').value = groupId;
        document.getElementById('groupName').value = group.name;
        document.getElementById('groupColor').value = group.color || '#0d6efd';
        document.getElementById('groupIcon').value = group.icon || 'fas fa-users';
        document.querySelectorAll('.color-pick').forEach(b => {
            b.style.borderColor = b.dataset.color === group.color ? 'white' : 'transparent';
        });
        document.querySelectorAll('.icon-pick').forEach(b => {
            b.classList.toggle('selected', b.dataset.icon === (group.icon || 'fas fa-users'));
        });
        document.getElementById('btnDeleteGroup').classList.remove('d-none');
        groupModal.show();
    }

    async function saveGroup() {
        const id = document.getElementById('groupEditId').value;
        const name = document.getElementById('groupName').value.trim();
        const color = document.getElementById('groupColor').value;
        const icon = document.getElementById('groupIcon').value;

        if (!name) {
            alert('Digite um nome para o grupo.');
            return;
        }

        if (!icon) {
            alert('Selecione um ícone para o grupo.');
            return;
        }

        try {
            if (id) {
                // Update
                await fetch(`/groups/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, color, icon })
                });
            } else {
                // Create
                await fetch('/groups', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, color, icon })
                });
            }
            groupModal.hide();
            loadGroups();
            loadPersons();
        } catch (e) {
            console.error(e);
            alert('Erro ao salvar grupo.');
        }
    }

    async function deleteGroup() {
        const id = document.getElementById('groupEditId').value;
        if (!id) return;

        if (!confirm('Excluir este grupo?\n\nAs pessoas do grupo não serão excluídas, apenas desvinculadas.')) return;

        try {
            await fetch(`/groups/${id}`, { method: 'DELETE' });
            groupModal.hide();
            loadGroups();
            loadPersons();
        } catch (e) {
            console.error(e);
            alert('Erro ao excluir grupo.');
        }
    }

    async function assignPersonToGroup(personId, groupId) {
        try {
            await fetch(`/persons/${personId}/group?group_id=${groupId || ''}`, { method: 'POST' });
            loadGroups();
            loadPersons();
        } catch (e) {
            console.error(e);
            alert('Erro ao atribuir grupo.');
        }
    }

    async function changePersonGroup() {
        const groupId = document.getElementById('personGroupSelect').value;
        if (!currentPersonId) return;

        try {
            await fetch(`/persons/${currentPersonId}/group?group_id=${groupId || ''}`, { method: 'POST' });
            loadGroups();
            // Don't reload persons here to avoid closing modal
        } catch (e) {
            console.error(e);
            alert('Erro ao alterar grupo.');
        }
    }

    // ==================== DRAG AND DROP MERGE ====================

    let draggedPersonId = null;
    let draggedPersonName = null;

    function handleDragStart(e) {
        draggedPersonId = this.dataset.personId;
        draggedPersonName = this.dataset.personName;
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', draggedPersonId);
    }

    function handleDragEnd(e) {
        this.classList.remove('dragging');
        document.querySelectorAll('.person-card').forEach(card => {
            card.classList.remove('drag-over');
        });
        document.querySelectorAll('.group-card').forEach(card => {
            card.classList.remove('drag-over');
        });
        draggedPersonId = null;
        draggedPersonName = null;
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        const targetId = this.dataset.personId;
        if (targetId !== draggedPersonId) {
            this.classList.add('drag-over');
        }
    }

    function handleDragLeave(e) {
        this.classList.remove('drag-over');
    }

    async function handleDrop(e) {
        e.preventDefault();
        e.stopPropagation();
        this.classList.remove('drag-over');

        const targetId = this.dataset.personId;
        const targetName = this.dataset.personName;
        const sourceId = draggedPersonId;
        const sourceName = draggedPersonName;

        if (!sourceId || !targetId || sourceId === targetId) return;

        // Confirma a mesclagem
        if (!confirm(`Mesclar "${sourceName}" em "${targetName}"?\n\nTodas as fotos de "${sourceName}" serão movidas para "${targetName}".`)) return;

        try {
            const res = await fetch('/persons/merge', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ source_id: parseInt(sourceId), target_id: parseInt(targetId) })
            });

            if (res.ok) {
                loadGroups();
                loadPersons();
                updateStats();
            } else {
                const data = await res.json();
                alert('Erro ao mesclar: ' + (data.detail || 'Desconhecido'));
            }
        } catch (e) {
            console.error(e);
            alert('Erro ao mesclar pessoas.');
        }
    }

    async function triggerRecluster() {
        if (!confirm('Isso vai re-agrupar todos os rostos sem pessoa associada.\n\nDeseja continuar?')) return;

        try {
            const res = await fetch('/cluster', { method: 'POST' });
            const data = await res.json();
            alert('Re-agrupamento iniciado em segundo plano!\n\nAguarde alguns segundos e atualize a lista.');
        } catch (e) {
            console.error(e);
            alert('Erro ao iniciar re-agrupamento.');
        }
    }

    async function fetchPersonsData() {
        try {
            await loadGroups(); // Ensure groups are loaded
            const res = await fetch('/persons');
            let persons = await res.json();

            if (persons.length === 0) return null;

            // Sort persons based on currentSortOrder
            const sortOrder = typeof currentSortOrder !== 'undefined' ? currentSortOrder : 'photos_desc';
            
            switch(sortOrder) {
                case 'photos_asc':
                    persons.sort((a, b) => a.face_count - b.face_count);
                    break;
                case 'name_asc':
                    persons.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                    break;
                case 'name_desc':
                    persons.sort((a, b) => (b.name || '').localeCompare(a.name || ''));
                    break;
                case 'recent':
                    persons.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    break;
                case 'photos_desc':
                default:
                    persons.sort((a, b) => b.face_count - a.face_count);
                    break;
            }

            // Group persons
            const personsByGroup = {};
            const ungroupedPersons = [];

            persons.forEach(person => {
                if (person.group_id) {
                    if (!personsByGroup[person.group_id]) {
                        personsByGroup[person.group_id] = [];
                    }
                    personsByGroup[person.group_id].push(person);
                } else {
                    ungroupedPersons.push(person);
                }
            });

            return { personsByGroup, ungroupedPersons };
        } catch (e) {
            console.error("Error fetching persons data:", e);
            throw e;
        }
    }

    function renderGroupsToContainer(containerId, data, showAddButton = true) {
        const container = document.getElementById(containerId);
        if (!container) return;

        container.innerHTML = '';

        if (!data) {
             container.innerHTML = '<div class="empty-state"><i class="fas fa-user-slash"></i><p>Nenhuma pessoa identificada ainda.<br>Execute o scanner em Configurações.</p></div>';
             return;
        }

        const { personsByGroup, ungroupedPersons } = data;

        if (showAddButton) {
            const addBtn = document.createElement('button');
            addBtn.className = 'add-group-btn';
            addBtn.onclick = openCreateGroupModal;
            addBtn.innerHTML = '<i class="fas fa-plus"></i> Novo Grupo';
            container.appendChild(addBtn);
        }

        groups.forEach(group => {
            const groupPersons = personsByGroup[group.id] || [];
            const groupContainer = createGroupContainer(group, groupPersons);
            container.appendChild(groupContainer);
        });

        if (ungroupedPersons.length > 0 || groups.length > 0) {
            const ungroupedContainer = createGroupContainer(
                { id: null, name: 'Sem Grupo', color: '#6c757d' },
                ungroupedPersons,
                true
            );
            container.appendChild(ungroupedContainer);
        }
    }

    async function loadPersons() {
        const container = document.getElementById('groupsContainers');
        container.innerHTML = '<div class="loading-container"><div class="spinner-border"></div><p>Carregando pessoas...</p></div>';

        try {
            const data = await fetchPersonsData();
            renderGroupsToContainer('groupsContainers', data, true);
        } catch (e) {
            console.error(e);
            container.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle text-danger"></i><p>Erro ao carregar pessoas.</p></div>';
        }
    }

    function createGroupContainer(group, persons, isUngrouped = false) {
        const div = document.createElement('div');
        div.className = 'group-container';
        div.dataset.groupId = group.id || 'none';

        // Header
        const header = document.createElement('div');
        header.className = 'group-header';
        const groupIconClass = group.icon || 'fas fa-users';
        const groupIcon = `<i class="${groupIconClass}"></i>`;
        header.innerHTML = `
            <div class="group-color" style="background-color: ${group.color || '#6c757d'}"></div>
            <span class="group-name">${groupIcon} ${group.name}</span>
            <span class="group-count">${persons.length} pessoa${persons.length !== 1 ? 's' : ''}</span>
            <div class="group-actions">
                ${!isUngrouped ? `<button class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation(); openEditGroupModal(${group.id})" title="Editar grupo"><i class="fas fa-pen"></i></button>` : ''}
            </div>
            <i class="fas fa-chevron-down"></i>
        `;
        header.onclick = (e) => {
            if (e.target.closest('.group-actions')) return;
            div.classList.toggle('collapsed');
            const icon = header.querySelector('.fa-chevron-down, .fa-chevron-right');
            icon.className = div.classList.contains('collapsed') ? 'fas fa-chevron-right' : 'fas fa-chevron-down';
        };
        div.appendChild(header);

        // Content
        const content = document.createElement('div');
        content.className = 'group-content' + (persons.length === 0 ? ' empty' : '');

        if (persons.length === 0) {
            content.innerHTML = '<span>Arraste pessoas para este grupo</span>';
        } else {
            persons.forEach(person => {
                const personCard = createPersonMiniCard(person);
                content.appendChild(personCard);
            });
        }

        div.appendChild(content);

        // Drop handlers for the container
        div.addEventListener('dragover', handleGroupContainerDragOver);
        div.addEventListener('dragleave', handleGroupContainerDragLeave);
        div.addEventListener('drop', handleGroupContainerDrop);

        return div;
    }

    function createPersonMiniCard(person) {
        const card = document.createElement('div');
        card.className = 'person-mini-card';
        card.dataset.personId = person.id;
        card.dataset.personName = person.name;
        card.draggable = true;

        let avatarSrc = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%23ddd"/><text x="50" y="60" text-anchor="middle" fill="%23999" font-size="40">?</text></svg>';
        if (person.representative_face_id) {
            avatarSrc = buildFaceThumbUrl(person.representative_face_id);
        }

        card.innerHTML = `
            <img src="${avatarSrc}" alt="${person.name}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2250%22 fill=%22%23ddd%22/><text x=%2250%22 y=%2260%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2240%22>?</text></svg>'">
            <div class="name">${person.name}</div>
            <div class="count">${person.face_count} foto${person.face_count !== 1 ? 's' : ''}</div>
        `;

        card.onclick = (e) => {
            if (!e.target.closest('.dragging')) {
                openPersonModal(person.id);
            }
        };
        card.addEventListener('dragstart', handlePersonMiniDragStart);
        card.addEventListener('dragend', handlePersonMiniDragEnd);
        card.addEventListener('dragover', handlePersonMiniDragOver);
        card.addEventListener('dragleave', handlePersonMiniDragLeave);
        card.addEventListener('drop', handlePersonMiniDrop);

        return card;
    }

    function handlePersonMiniDragStart(e) {
        draggedPersonId = this.dataset.personId;
        draggedPersonName = this.dataset.personName;
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', draggedPersonId);
    }

    function handlePersonMiniDragEnd(e) {
        this.classList.remove('dragging');
        document.querySelectorAll('.group-container').forEach(c => c.classList.remove('drag-over'));
        document.querySelectorAll('.person-mini-card').forEach(c => c.classList.remove('drag-over'));
        draggedPersonId = null;
        draggedPersonName = null;
    }

    function handlePersonMiniDragOver(e) {
        e.preventDefault();
        e.stopPropagation();
        const targetId = this.dataset.personId;
        if (targetId !== draggedPersonId) {
            this.classList.add('drag-over');
        }
    }

    function handlePersonMiniDragLeave(e) {
        this.classList.remove('drag-over');
    }

    async function handlePersonMiniDrop(e) {
        e.preventDefault();
        e.stopPropagation();
        this.classList.remove('drag-over');

        const targetId = this.dataset.personId;
        const targetName = this.dataset.personName;
        const sourceId = draggedPersonId;
        const sourceName = draggedPersonName;

        if (!sourceId || !targetId || sourceId === targetId) return;

        // Confirm merge
        if (!confirm(`Mesclar "${sourceName}" em "${targetName}"?\n\nTodas as fotos de "${sourceName}" serão movidas para "${targetName}".`)) return;

        try {
            const res = await fetch('/persons/merge', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ source_id: parseInt(sourceId), target_id: parseInt(targetId) })
            });

            if (res.ok) {
                loadPersons();
            } else {
                const data = await res.json();
                alert('Erro ao mesclar: ' + (data.detail || 'Desconhecido'));
            }
        } catch (e) {
            console.error(e);
            alert('Erro ao mesclar pessoas.');
        }
    }

    function handleGroupContainerDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        this.classList.add('drag-over');
    }

    function handleGroupContainerDragLeave(e) {
        // Only remove if leaving the container entirely
        if (!this.contains(e.relatedTarget)) {
            this.classList.remove('drag-over');
        }
    }

    async function handleGroupContainerDrop(e) {
        e.preventDefault();
        e.stopPropagation();
        this.classList.remove('drag-over');

        const targetGroupId = this.dataset.groupId;
        const personId = draggedPersonId;

        if (!personId) return;

        // If dropping on "none" group, remove from group
        const groupIdParam = targetGroupId === 'none' ? '' : targetGroupId;

        try {
            await fetch(`/persons/${personId}/group?group_id=${groupIdParam}`, { method: 'POST' });
            loadPersons();
        } catch (e) {
            console.error(e);
            alert('Erro ao mover pessoa para o grupo.');
        }
    }

    function initPersonPhotosObserver() {
        const sentinel = document.getElementById('personPhotosSentinel');
        const modalBody = document.querySelector('#personModal .modal-body');
        if (!sentinel || !modalBody || personPhotosObserver) return;

        personPhotosObserver = new IntersectionObserver((entries) => {
            const entry = entries[0];
            if (!entry.isIntersecting) return;
            if (!personPhotosHasMore || personPhotosLoading || !currentPersonId) return;
            loadPersonPhotos(currentPersonId, false);
        }, { root: modalBody, rootMargin: '200px' });
    }

    async function openPersonModal(personId) {
        currentPersonId = personId;
        const grid = document.getElementById('personPhotosGrid');
        const sentinel = document.getElementById('personPhotosSentinel');
        const status = document.getElementById('personPhotosStatus');
        const endMsg = document.getElementById('personPhotosEnd');

        grid.innerHTML = '<div class="loading-container"><div class="spinner-border"></div></div>';
        if (sentinel) sentinel.classList.add('d-none');
        personModal.show();

        personPhotosOffset = 0;
        personPhotosHasMore = false;
        personPhotosLoading = false;
        currentPersonPhotos = [];
        personPhotosTotal = 0;
        if (status) {
            status.classList.add('d-none');
            status.textContent = '';
        }
        if (endMsg) {
            endMsg.classList.add('d-none');
        }

        if (personPhotosObserver && sentinel) {
            personPhotosObserver.observe(sentinel);
        }

        await loadPersonPhotos(personId, true);
    }

    async function loadPersonPhotos(personId, reset = false) {
        if (personPhotosLoading) return;
        personPhotosLoading = true;

        const grid = document.getElementById('personPhotosGrid');
        const nameInput = document.getElementById('personNameInput');
        const groupSelect = document.getElementById('personGroupSelect');
        const sentinel = document.getElementById('personPhotosSentinel');
        const status = document.getElementById('personPhotosStatus');
        const endMsg = document.getElementById('personPhotosEnd');
        const photoLimit = getPersonPhotoLimit();

        if (reset) {
            grid.innerHTML = '<div class="loading-container"><div class="spinner-border"></div></div>';
        } else if (sentinel) {
            sentinel.classList.remove('d-none');
        }

        try {
            const res = await fetch(`/persons/${personId}?limit=${photoLimit}&offset=${personPhotosOffset}`);
            const data = await res.json();

            if (reset) {
                nameInput.value = data.name;

                // Populate group select
                groupSelect.innerHTML = '<option value="">Sem grupo</option>' +
                    groups.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
                groupSelect.value = data.group_id || '';

                grid.innerHTML = '';
                personPhotosTotal = data.photo_count || 0;
                updatePersonPhotosStatus();
            }

            if (data.photos.length === 0 && reset) {
                grid.innerHTML = '<div class="empty-state"><p>Nenhuma foto encontrada.</p></div>';
                currentPersonPhotos = [];
                personPhotosHasMore = false;
                if (sentinel) sentinel.classList.add('d-none');
                if (status) {
                    status.classList.remove('d-none');
                    status.textContent = 'Exibindo 0 de 0';
                }
                if (endMsg) {
                    endMsg.classList.add('d-none');
                }
                return;
            }

            appendPersonPhotos(data.photos);

            personPhotosOffset += data.photos.length;
            const totalCount = data.photo_count || currentPersonPhotos.length;
            personPhotosHasMore = data.has_more !== undefined ? data.has_more : personPhotosOffset < totalCount;
            updatePersonPhotosStatus();

            if (sentinel) {
                sentinel.classList.toggle('d-none', !personPhotosHasMore);
            }
            if (endMsg) {
                endMsg.classList.toggle('d-none', personPhotosHasMore || currentPersonPhotos.length === 0);
            }
        } catch (e) {
            console.error(e);
            if (reset) {
                grid.innerHTML = '<div class="empty-state text-danger"><p>Erro ao carregar.</p></div>';
            }
        } finally {
            personPhotosLoading = false;
        }
    }

    function updatePersonPhotosStatus() {
        const status = document.getElementById('personPhotosStatus');
        if (!status) return;
        if (!currentPersonId) {
            status.classList.add('d-none');
            status.textContent = '';
            return;
        }

        const total = personPhotosTotal || currentPersonPhotos.length;
        status.textContent = `Exibindo ${currentPersonPhotos.length} de ${total}`;
        status.classList.remove('d-none');
    }

    function appendPersonPhotos(photos) {
        const grid = document.getElementById('personPhotosGrid');
        const baseIndex = currentPersonPhotos.length;

        warmThumbCache(photos);

        photos.forEach((photo, idx) => {
            const displayPath = photo.file_path.replace('/mnt/photos', '/photos');
            const col = document.createElement('div');
            col.className = 'col-6 col-md-4 col-lg-3';

            const globalIdx = baseIndex + idx;
            currentPersonPhotos.push({
                path: displayPath,
                filename: photo.filename,
                index: globalIdx,
                photo_id: photo.photo_id,
                width: photo.width || null,
                height: photo.height || null
            });

            // Cria o card com marcador de rosto
            const card = document.createElement('div');
            card.className = 'person-photo-card';
            card.dataset.photoId = photo.photo_id;  // Para selecao
            card.dataset.photoIndex = globalIdx;  // For viewer navigation
            const thumbSrc = buildPhotoThumbUrl(photo.photo_id);
            card.innerHTML = `
                <img src="${thumbSrc}" data-full="${displayPath}" alt="${photo.filename}" onclick="if(!photoSelectMode) openPhotoViewer(currentPersonPhotos, ${globalIdx})" onerror="this.src='${displayPath}'">
                <div class="marker-loading">Marcando...</div>
                <button class="remove-btn" onclick="event.stopPropagation(); excludeFaceFromPerson(${photo.face_id}, ${currentPersonId}, this.closest('.col-6, .col-md-4, .col-lg-3'))" title="Não é essa pessoa">
                    <i class="fas fa-times"></i>
                </button>
            `;

            col.appendChild(card);
            grid.appendChild(col);

            if (photoSelectMode) {
                card.classList.add('selectable');
                card.onclick = function(e) {
                    if (e.target.closest('.remove-btn')) return;
                    togglePhotoSelection(card);
                };
            }

            // Adiciona marcador do rosto após a imagem carregar
            if (photo.face_location) {
                const img = card.querySelector('img');
                const addFaceMarker = function() {
                    // Espera um frame para garantir que o elemento esta no DOM e tem dimensoes
                    requestAnimationFrame(() => {
                        const [top, right, bottom, left] = photo.face_location;

                        // Calcula escala baseada no tamanho exibido vs tamanho real
                        const imgWidth = photo.width || img.naturalWidth;
                        const imgHeight = photo.height || img.naturalHeight;
                        const displayWidth = img.offsetWidth;
                        const displayHeight = img.offsetHeight;

                        // Ignora se a imagem ainda não tem dimensões
                        if (!displayWidth || !displayHeight || !imgWidth || !imgHeight) return;

                        // Remove marcador anterior (se existir)
                        const existingMarker = card.querySelector('.face-marker');
                        if (existingMarker) existingMarker.remove();

                        // object-fit: cover - calcula a escala e offset
                        const imgRatio = imgWidth / imgHeight;
                        const containerRatio = displayWidth / displayHeight;

                        let scale, offsetX = 0, offsetY = 0;
                        if (imgRatio > containerRatio) {
                            // Imagem mais larga - cortada nas laterais
                            scale = displayHeight / imgHeight;
                            offsetX = (imgWidth * scale - displayWidth) / 2;
                        } else {
                            // Imagem mais alta - cortada em cima/baixo
                            scale = displayWidth / imgWidth;
                            offsetY = (imgHeight * scale - displayHeight) / 2;
                        }

                        const cachedMarker = getMarkerFromCache(photo.photo_id, photo.face_id, displayWidth, displayHeight);
                        if (cachedMarker) {
                            const marker = document.createElement('div');
                            marker.className = 'face-marker marker-ready';
                            marker.style.left = `${Math.max(0, cachedMarker.left)}px`;
                            marker.style.top = `${Math.max(0, cachedMarker.top)}px`;
                            marker.style.width = `${Math.min(cachedMarker.width, displayWidth - cachedMarker.left)}px`;
                            marker.style.height = `${Math.min(cachedMarker.height, displayHeight - cachedMarker.top)}px`;
                            marker.style.display = showFaceMarkers ? 'block' : 'none';
                            const placeholder = card.querySelector('.marker-loading');
                            if (placeholder) placeholder.remove();
                            card.appendChild(marker);
                        }

                        // Calcula posicao do marcador
                        const markerLeft = (left * scale) - offsetX;
                        const markerTop = (top * scale) - offsetY;
                        const markerWidth = (right - left) * scale;
                        const markerHeight = (bottom - top) * scale;

                        // So mostra se estiver visivel na area de corte
                        if (markerLeft + markerWidth > 0 && markerLeft < displayWidth &&
                            markerTop + markerHeight > 0 && markerTop < displayHeight) {
                            const marker = document.createElement('div');
                            marker.className = 'face-marker marker-ready';
                            marker.style.left = Math.max(0, markerLeft) + 'px';
                            marker.style.top = Math.max(0, markerTop) + 'px';
                            marker.style.width = Math.min(markerWidth, displayWidth - markerLeft) + 'px';
                            marker.style.height = Math.min(markerHeight, displayHeight - markerTop) + 'px';
                            marker.style.display = showFaceMarkers ? 'block' : 'none';
                            const placeholder = card.querySelector('.marker-loading');
                            if (placeholder) placeholder.remove();
                            card.appendChild(marker);

                            setMarkerCache(photo.photo_id, photo.face_id, displayWidth, displayHeight, Math.max(0, markerLeft), Math.max(0, markerTop), Math.min(markerWidth, displayWidth - markerLeft), Math.min(markerHeight, displayHeight - markerTop));
                        } else {
                            const placeholder = card.querySelector('.marker-loading');
                            if (placeholder) placeholder.textContent = 'Sem marcador';
                        }
                    });
                };

                const fallbackTimeout = setTimeout(() => {
                    if (!card.querySelector('.face-marker') && card.querySelector('.marker-loading')) {
                        card.querySelector('.marker-loading').textContent = 'Ajustando...';
                    }
                }, 700);

                // Renderiza o marcador imediatamente usando dimensões do banco
                addFaceMarker();

                if (img.complete && (img.naturalWidth || (photo.width && photo.height))) {
                    // Imagem ja esta carregada (cache)
                    addFaceMarker();
                } else {
                    img.onload = addFaceMarker;
                }

                img.addEventListener('load', () => clearTimeout(fallbackTimeout), { once: true });
            }
        });
    }

    async function updatePersonName() {
        if (!currentPersonId) return;
        const name = document.getElementById('personNameInput').value.trim();
        if (!name) return;

        try {
            await fetch(`/persons/${currentPersonId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name })
            });
            loadPersons();
        } catch (e) {
            console.error(e);
            alert('Erro ao atualizar nome');
        }
    }

    async function excludeFaceFromPerson(faceId, personId, colElement) {
        if (!confirm('Marcar como "Não é essa pessoa"? A foto será removida deste grupo.')) return;

        try {
            const res = await fetch(`/persons/${personId}/exclude`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ face_id: faceId })
            });
            const data = await res.json();

            if (data.success) {
                colElement.remove();
                updateStats();
            } else {
                alert('Erro: ' + (data.error || 'Desconhecido'));
            }
        } catch (e) {
            console.error(e);
            alert('Erro ao excluir');
        }
    }

    // ==================== PHOTO SELECTION ====================

    function togglePhotoSelectMode() {
        photoSelectMode = true;
        selectedPhotos = [];
        document.getElementById('btnSelectMode').classList.add('d-none');
        document.getElementById('photoActions').classList.remove('d-none');
        document.getElementById('selectedCount').classList.remove('d-none');
        updateSelectedCount();

        // Add selectable class to all photo cards
        document.querySelectorAll('#personPhotosGrid .person-photo-card').forEach(card => {
            card.classList.add('selectable');
            card.onclick = function(e) {
                if (e.target.closest('.remove-btn')) return;
                togglePhotoSelection(card);
            };
        });
    }

    function cancelPhotoSelectMode() {
        photoSelectMode = false;
        selectedPhotos = [];
        document.getElementById('btnSelectMode').classList.remove('d-none');
        document.getElementById('photoActions').classList.add('d-none');
        document.getElementById('selectedCount').classList.add('d-none');

        // Remove selectable class
        document.querySelectorAll('#personPhotosGrid .person-photo-card').forEach(card => {
            card.classList.remove('selectable', 'selected');
            card.onclick = null;
        });
    }

    function togglePhotoSelection(card) {
        const photoId = parseInt(card.dataset.photoId);
        const idx = selectedPhotos.findIndex(p => p.photo_id === photoId);

        if (idx === -1) {
            selectedPhotos.push({ photo_id: photoId });
            card.classList.add('selected');
        } else {
            selectedPhotos.splice(idx, 1);
            card.classList.remove('selected');
        }
        updateSelectedCount();
    }

    function selectAllPhotos() {
        selectedPhotos = [];
        document.querySelectorAll('#personPhotosGrid .person-photo-card').forEach(card => {
            const photoId = parseInt(card.dataset.photoId);
            selectedPhotos.push({ photo_id: photoId });
            card.classList.add('selected');
        });
        updateSelectedCount();
    }

    function updateSelectedCount() {
        document.getElementById('selectedCount').textContent = `${selectedPhotos.length} selecionada${selectedPhotos.length !== 1 ? 's' : ''}`;
    }

    async function downloadSelectedPhotos() {
        if (selectedPhotos.length === 0) {
            alert('Selecione pelo menos uma foto.');
            return;
        }

        try {
            const res = await fetch('/photos/download', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ photo_ids: selectedPhotos.map(p => p.photo_id) })
            });

            if (!res.ok) throw new Error('Download failed');

            // Trigger download
            const blob = await res.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `photos_${Date.now()}.zip`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        } catch (e) {
            console.error(e);
            alert('Erro ao baixar fotos.');
        }
    }

    async function showCopyMoveModal() {
        if (selectedPhotos.length === 0) {
            alert('Selecione pelo menos uma foto.');
            return;
        }

        // Load destinations
        const select = document.getElementById('destinationFolder');
        select.innerHTML = '<option value="">Carregando...</option>';

        try {
            const res = await fetch('/photos/destinations');
            const data = await res.json();

            select.innerHTML = '<option value="">-- Selecione uma pasta --</option>';
            data.destinations.forEach(dest => {
                select.innerHTML += `<option value="${dest}">${dest}</option>`;
            });
        } catch (e) {
            select.innerHTML = '<option value="">Erro ao carregar</option>';
        }

        document.getElementById('newFolderName').value = '';
        copyMoveModal.show();
    }

    async function executeCopyMove() {
        const mode = document.querySelector('input[name="copyMoveMode"]:checked').value;
        let destination = document.getElementById('destinationFolder').value;
        const newFolder = document.getElementById('newFolderName').value.trim();

        if (newFolder) {
            destination = newFolder;
        }

        if (!destination) {
            alert('Selecione ou digite uma pasta de destino.');
            return;
        }

        const actionText = mode === 'copy' ? 'copiar' : 'mover';
        if (!confirm(`Deseja ${actionText} ${selectedPhotos.length} foto(s) para "${destination}"?`)) return;

        try {
            const res = await fetch('/photos/copy-move', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    photo_ids: selectedPhotos.map(p => p.photo_id),
                    destination: destination,
                    mode: mode
                })
            });
            const data = await res.json();

            copyMoveModal.hide();

            if (data.success > 0) {
                alert(`${data.success} foto(s) ${mode === 'copy' ? 'copiada(s)' : 'movida(s)'} com sucesso!${data.failed > 0 ? `\n${data.failed} falha(s).` : ''}`);
                cancelPhotoSelectMode();
                if (mode === 'move') {
                    openPersonModal(currentPersonId); // Reload
                }
            } else {
                alert('Erro: Nenhuma foto foi processada.');
            }
        } catch (e) {
            console.error(e);
            alert('Erro ao processar fotos.');
        }
    }

    // ==================== PHOTOS / FACES ====================

    async function openPhotoModal(photoId, filePath) {
        const img = document.getElementById('modalImage');
        const overlayContainer = document.getElementById('faceOverlays');
        img.src = filePath;
        overlayContainer.innerHTML = '';
        photoModal.show();

        try {
            const res = await fetch(`/photo/${photoId}/detect`);
            const faces = await res.json();
            drawFaceBoxes(faces, img);
        } catch(e) { console.error("Erro rostos", e); }
    }

    function drawFaceBoxes(faces, imgElement) {
        const container = document.getElementById('faceOverlays');
        if (!imgElement.complete) {
            imgElement.onload = () => drawFaceBoxes(faces, imgElement);
            return;
        }

        const scaleX = imgElement.width / imgElement.naturalWidth;
        const scaleY = imgElement.height / imgElement.naturalHeight;

        faces.forEach(face => {
            if (!face.face_id) return;
            const [top, right, bottom, left] = face.location;
            const box = document.createElement('div');
            box.className = 'face-box';
            box.style.top = (top * scaleY) + 'px';
            box.style.left = (left * scaleX) + 'px';
            box.style.width = ((right - left) * scaleX) + 'px';
            box.style.height = ((bottom - top) * scaleY) + 'px';
            box.onclick = () => searchByFaceId(face.face_id);
            container.appendChild(box);
        });
    }

    async function searchByFaceId(faceId) {
        photoModal.hide();
        const triggerEl = document.querySelector('#myTab button[data-bs-target="#search"]');
        bootstrap.Tab.getInstance(triggerEl)?.show() || new bootstrap.Tab(triggerEl).show();

        renderLoading();
        try {
            const res = await fetch(`/search/by-id?face_id=${faceId}`);
            const data = await res.json();
            renderResults(data.matches || []);
        } catch (e) {
            console.error(e);
            alert("Erro ao buscar");
        }
    }

    async function searchFace() {
        const input = document.getElementById('faceInput');
        if (!input.files[0]) { alert("Selecione uma foto."); return; }

        const formData = new FormData();
        formData.append("file", input.files[0]);

        renderLoading();
        try {
            const res = await fetch('/search/face', { method: 'POST', body: formData });
            const data = await res.json();
            renderResults(data.matches || []);
        } catch (e) {
            alert("Erro ao buscar");
            document.getElementById('resultsGrid').innerHTML = '';
        }
    }

    async function searchMetadata() {
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;
        const camera = document.getElementById('cameraModel').value;

        const params = new URLSearchParams();
        if (start) params.append("start_date", start);
        if (end) params.append("end_date", end);
        if (camera) params.append("camera_model", camera);

        renderLoading();
        try {
            const res = await fetch(`/search/metadata?${params.toString()}`);
            const data = await res.json();
            renderResults(data);
        } catch (e) {
            alert("Erro ao filtrar");
            document.getElementById('resultsGrid').innerHTML = '';
        }
    }

    function setQuickDateFilter(period) {
        const today = new Date();
        let startDate = new Date();
        
        switch(period) {
            case 'today':
                // Just today
                break;
            case 'week':
                startDate.setDate(today.getDate() - 7);
                break;
            case 'month':
                startDate.setMonth(today.getMonth() - 1);
                break;
            case 'year':
                startDate.setFullYear(today.getFullYear() - 1);
                break;
        }
        
        document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
        document.getElementById('endDate').value = today.toISOString().split('T')[0];
        
        // Auto-search
        searchMetadata();
    }

    function clearPhotoFilters() {
        document.getElementById('startDate').value = '';
        document.getElementById('endDate').value = '';
        document.getElementById('cameraModel').value = '';
        document.getElementById('resultsGrid').innerHTML = '<div class="empty-state py-3"><i class="fas fa-search"></i><p class="small mb-0">Resultados aqui</p></div>';
        document.getElementById('resultCount').textContent = '0';
        searchResultPhotos = [];
    }

    function filterPersonsByName() {
        const searchTerm = document.getElementById('personSearchInput').value.toLowerCase().trim();
        const personCards = document.querySelectorAll('#groupsContainers .person-mini-card');
        const groupContainers = document.querySelectorAll('#groupsContainers .group-container');
        
        personCards.forEach(card => {
            const name = (card.dataset.personName || '').toLowerCase();
            const matches = !searchTerm || name.includes(searchTerm);
            card.style.display = matches ? '' : 'none';
        });
        
        // Hide empty groups when filtering
        groupContainers.forEach(group => {
            const visibleCards = group.querySelectorAll('.person-mini-card:not([style*="display: none"])');
            const groupContent = group.querySelector('.group-content');
            if (searchTerm && visibleCards.length === 0) {
                group.style.display = 'none';
            } else {
                group.style.display = '';
            }
        });
    }

    let currentSortOrder = 'photos_desc';
    
    function sortPersons() {
        currentSortOrder = document.getElementById('personSortSelect').value;
        loadPersons(); // Reload with new sort
    }

    function renderLoading() {
        document.getElementById('resultsGrid').innerHTML = '<div class="loading-container"><div class="spinner-border"></div><p>Buscando...</p></div>';
    }

    let searchResultPhotos = []; // Store search results for viewer

    function renderResults(items) {
        const grid = document.getElementById('resultsGrid');
        document.getElementById('resultCount').innerText = items.length;
        grid.innerHTML = '';

        if (items.length === 0) {
            grid.innerHTML = '<div class="empty-state"><i class="fas fa-search"></i><p>Nenhuma correspondencia.</p></div>';
            searchResultPhotos = [];
            return;
        }

        // Store photos for viewer navigation
        searchResultPhotos = items.map((item, idx) => ({
            path: item.file_path.replace('/mnt/photos', '/photos'),
            filename: item.filename,
            index: idx,
            photo_id: item.photo_id || item.id,
            capture_date: item.capture_date,
            similarity: item.similarity,
            distance: item.distance
        }));

        items.forEach((item, idx) => {
            const displayPath = item.file_path.replace('/mnt/photos', '/photos');
            const thumbId = item.photo_id || item.id;
            const thumbSrc = thumbId ? buildPhotoThumbUrl(thumbId) : displayPath;
            const col = document.createElement('div');
            col.className = 'col-4 col-md-3 col-lg-2 mb-2';
            const matchScore = item.distance !== undefined ? `<span class="badge bg-success">${((1 - item.distance) * 100).toFixed(0)}%</span>` : '';

            col.innerHTML = `
                <div class="photo-card h-100" style="cursor: pointer;">
                    <img src="${thumbSrc}" class="thumbnail" alt="Foto" onerror="this.src='${displayPath}'" style="aspect-ratio: 1; object-fit: cover;">
                    <div class="p-1 small">
                        <div class="filename text-truncate" title="${item.filename}">${item.filename}</div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted small">${item.capture_date ? new Date(item.capture_date).toLocaleDateString('pt-BR') : ''}</span>
                            ${matchScore}
                        </div>
                    </div>
                </div>
            `;
            col.onclick = () => openPhotoViewer(searchResultPhotos, idx);
            grid.appendChild(col);
        });
    }

    // ==================== ALL PHOTOS MODAL ====================

    let allPhotosData = [];
    let currentAllPhotosFilter = 'all';

    function openAllPhotosModal(filter = 'all') {
        currentAllPhotosFilter = filter;
        allPhotosModal.show();
        loadAllPhotosGrid(filter);
    }

    async function loadAllPhotosGrid(filter = 'all') {
        const grid = document.getElementById('allPhotosGrid');
        const countEl = document.getElementById('allPhotosCount');
        
        // Update button states
        document.getElementById('btnFilterAll').classList.toggle('active', filter === 'all');
        document.getElementById('btnFilterFaces').classList.toggle('active', filter === 'faces');
        
        // Update title
        document.getElementById('allPhotosModalTitle').innerHTML = filter === 'faces' 
            ? '<i class="fas fa-user-circle"></i> Fotos com Rostos'
            : '<i class="fas fa-images"></i> Todas as Fotos';
        
        grid.innerHTML = '<div class="text-center py-5 w-100"><div class="spinner-border"></div><p class="mt-2">Carregando fotos...</p></div>';
        currentAllPhotosFilter = filter;

        try {
            let url = filter === 'faces' ? '/faces/all?limit=200' : '/search/metadata?limit=200';
            const res = await fetch(url);
            let data = await res.json();
            
            // Normalize data structure
            if (filter === 'faces') {
                // faces/all returns array of photos with face_count
                allPhotosData = data.map((item, idx) => ({
                    path: item.file_path.replace('/mnt/photos', '/photos'),
                    filename: item.filename,
                    index: idx,
                    photo_id: item.id,
                    face_count: item.face_count,
                    capture_date: item.capture_date
                }));
            } else {
                // search/metadata returns array of photos
                allPhotosData = data.map((item, idx) => ({
                    path: item.file_path.replace('/mnt/photos', '/photos'),
                    filename: item.filename,
                    index: idx,
                    photo_id: item.id,
                    capture_date: item.capture_date
                }));
            }

            countEl.textContent = allPhotosData.length;
            grid.innerHTML = '';

            if (allPhotosData.length === 0) {
                grid.innerHTML = '<div class="text-center py-5 w-100 text-muted"><i class="fas fa-images fa-3x mb-3"></i><p>Nenhuma foto encontrada</p></div>';
                return;
            }

            allPhotosData.forEach((photo, idx) => {
                const thumbSrc = buildPhotoThumbUrl(photo.photo_id);
                const img = document.createElement('img');
                img.className = 'photo-thumb';
                img.src = thumbSrc;
                img.alt = photo.filename;
                img.title = photo.filename;
                img.loading = 'lazy';
                img.onclick = () => {
                    allPhotosModal.hide();
                    openPhotoViewer(allPhotosData, idx);
                };
                img.onerror = () => { img.src = photo.path; };
                grid.appendChild(img);
            });
        } catch (e) {
            console.error('Error loading photos:', e);
            grid.innerHTML = '<div class="text-center py-5 w-100 text-danger"><i class="fas fa-exclamation-triangle fa-2x mb-2"></i><p>Erro ao carregar fotos</p></div>';
        }
    }

    // ==================== FOLDERS / SCAN ====================

    async function loadFolders() {
        renderScanFolderList();
    }

    function renderScanFolderList() {
        const list = document.getElementById('folderList');
        if (!list) return;

        if (!selectedScanFolders.length) {
            list.innerHTML = '<div class="text-secondary p-3">Nenhuma pasta selecionada.</div>';
            return;
        }

        list.innerHTML = selectedScanFolders.map(path => `
            <div class="folder-item d-flex justify-content-between align-items-center">
                <span><i class="fas fa-folder text-warning"></i> ${path}</span>
                <button class="btn btn-sm btn-outline-danger" onclick="removeScanFolder('${path}')"><i class="fas fa-times"></i></button>
            </div>
        `).join('');

        renderWelcomeFolderList();
    }

    function renderWelcomeFolderList() {
        const list = document.getElementById('welcomeFolderList');
        if (!list) return;

        if (!selectedScanFolders.length) {
            list.innerHTML = '<div class="text-secondary p-3">Nenhuma pasta selecionada.</div>';
            return;
        }

        list.innerHTML = selectedScanFolders.map(path => `
            <div class="folder-item d-flex justify-content-between align-items-center">
                <span><i class="fas fa-folder text-warning"></i> ${path}</span>
                <button class="btn btn-sm btn-outline-danger" onclick="removeScanFolder('${path}')"><i class="fas fa-times"></i></button>
            </div>
        `).join('');
    }

    function removeScanFolder(path) {
        selectedScanFolders = selectedScanFolders.filter(item => item !== path);
        renderScanFolderList();
    }

    function clearScanFolders() {
        selectedScanFolders = [];
        renderScanFolderList();
    }

    function openScanFolderModal() {
        scanBrowsePath = '/mnt/photos';
        loadScanFolders(scanBrowsePath);
        scanFolderModal.show();
    }

    async function loadScanFolders(path) {
        const list = document.getElementById('scanFolderList');
        const breadcrumb = document.getElementById('scanBreadcrumb');
        const currentLabel = document.getElementById('scanCurrentPath');
        if (!list) return;

        list.innerHTML = '<div class="text-center text-secondary py-3"><i class="fas fa-spinner fa-spin"></i> Carregando...</div>';
        try {
            const res = await fetch(`/directories?path=${encodeURIComponent(path)}`);
            if (!res.ok) {
                throw new Error('Erro ao carregar pastas');
            }
            const data = await res.json();
            scanBrowsePath = data.path;

            if (currentLabel) currentLabel.textContent = scanBrowsePath;
            if (breadcrumb) renderScanBreadcrumb(scanBrowsePath);

            if (!data.directories.length) {
                list.innerHTML = '<div class="text-secondary small">Nenhuma subpasta.</div>';
                return;
            }

            list.innerHTML = data.directories.map(dir => {
                const checked = selectedScanFolders.includes(dir.path) ? 'checked' : '';
                return `
                    <div class="capture-folder-item">
                        <input class="form-check-input me-2 scan-folder-check" type="checkbox" value="${dir.path}" ${checked}>
                        <span class="flex-grow-1" style="cursor: pointer;" onclick="loadScanFolders('${dir.path}')">
                            <i class="fas fa-folder"></i> ${dir.name}
                        </span>
                        <button class="btn btn-sm btn-outline-secondary" type="button" onclick="loadScanFolders('${dir.path}')">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                `;
            }).join('');
        } catch (e) {
            console.error(e);
            list.innerHTML = '<div class="text-danger small">Erro ao carregar pastas.</div>';
        }
    }

    function renderScanBreadcrumb(path) {
        const breadcrumb = document.getElementById('scanBreadcrumb');
        if (!breadcrumb) return;

        const parts = path.split('/').filter(Boolean);
        let acc = '';
        let html = '<div class="capture-breadcrumb">';
        parts.forEach((part, idx) => {
            acc += '/' + part;
            if (idx === parts.length - 1) {
                html += `<span>${part}</span>`;
            } else {
                html += `<button type="button" onclick="loadScanFolders('${acc}')">${part}</button><span>/</span>`;
            }
        });
        html += '</div>';
        breadcrumb.innerHTML = html;
    }

    function addScanFolders() {
        const checks = document.querySelectorAll('.scan-folder-check:checked');
        const paths = Array.from(checks).map(cb => cb.value);
        selectedScanFolders = Array.from(new Set([...selectedScanFolders, ...paths]));
        renderScanFolderList();
        scanFolderModal.hide();
    }

    async function triggerScan() {
        const selected = [...selectedScanFolders];

        if (selected.length === 0) {
            if (!confirm("Nenhuma pasta selecionada. Escanear TUDO?")) return;
        }

        if (confirm("Iniciar scan?")) {
            await fetch('/scan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ folders: selected })
            });
            alert("Scan iniciado! Acompanhe o progresso no rodapé.");
            updateStats();
        }
    }

    async function triggerOrganize() {
        const mode = document.querySelector('input[name="orgMode"]:checked').value;
        const destination = document.getElementById('organizeDestination')?.value.trim();
        if (confirm(`${mode === 'copy' ? 'Copiar' : 'Mover'} arquivos?`)) {
            let url = `/organize?mode=${mode}`;
            if (destination) {
                url += `&dest=${encodeURIComponent(destination)}`;
            }
            await fetch(url, { method: 'POST' });
            alert("Organização iniciada!");
        }
    }

    // ==================== VIDEO ====================

        let videoStream = null;
        let videoInterval = null;
        let liveVideoInterval = null;
        const VIDEO_CANVAS = document.createElement('canvas');
        const VIDEO_CTX = VIDEO_CANVAS.getContext('2d');


    // Remove discoverCameras from checkVideoStatus since we will use local webcam mostly
    let camerasDiscovered = false;

    function loadOnvifSettings() {
        const ip = localStorage.getItem('onvifIp') || '172.16.0.177';
        const user = localStorage.getItem('onvifUser') || '';
        const pass = localStorage.getItem('onvifPass') || '';
        const onvifIp = document.getElementById('onvifIp');
        const onvifUser = document.getElementById('onvifUser');
        const onvifPass = document.getElementById('onvifPass');
        if (onvifIp) onvifIp.value = ip;
        if (onvifUser) onvifUser.value = user;
        if (onvifPass) onvifPass.value = pass;

        const liveOnvifIp = document.getElementById('liveOnvifIp');
        const liveOnvifUser = document.getElementById('liveOnvifUser');
        const liveOnvifPass = document.getElementById('liveOnvifPass');
        if (liveOnvifIp) liveOnvifIp.value = ip;
        if (liveOnvifUser) liveOnvifUser.value = user;
        if (liveOnvifPass) liveOnvifPass.value = pass;
    }

    function saveOnvifSettings() {
        const ip = (document.getElementById('onvifIp') || document.getElementById('liveOnvifIp')).value.trim();
        const user = (document.getElementById('onvifUser') || document.getElementById('liveOnvifUser')).value.trim();
        const pass = (document.getElementById('onvifPass') || document.getElementById('liveOnvifPass')).value.trim();
        localStorage.setItem('onvifIp', ip);
        localStorage.setItem('onvifUser', user);
        localStorage.setItem('onvifPass', pass);
        return { ip, user, pass };
    }

    async function discoverCameras() {
        const select = document.getElementById('videoSource') || document.getElementById('liveVideoSource');
        const btn = select.nextElementSibling; // The refresh button
        const originalIcon = btn.innerHTML;

        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.disabled = true;

        const { ip, user, pass } = saveOnvifSettings();

        try {
            const res = await fetch('/cameras/discover', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    ip,
                    username: user || null,
                    password: pass || null,
                    ports: [80, 8899, 8000, 8080, 5000]
                })
            });
            const data = await res.json();

            const current = select.value;

            let html = '<option value="webcam">Webcam Local (Navegador)</option>';

            if (data.cameras && data.cameras.length > 0) {
                html += '<optgroup label="Câmeras IP (ONVIF)">';
                data.cameras.forEach(c => {
                    const label = c.name && c.name !== 'Unknown Camera' ? `${c.name} (${c.ip})` : `Câmera ${c.ip}`;
                    html += `<option value="${c.rtsp_url}">${label}</option>`;
                });
                html += '</optgroup>';
            }

            html += '<option value="custom">URL RTSP Personalizada</option>';
            select.innerHTML = html;

            // Re-append saved cameras
            updateLiveCameraOptions();

            if (current && current !== 'webcam' && select.querySelector(`option[value="${current}"]`)) {
                select.value = current;
            } else {
                select.value = 'webcam';
            }

            select.dispatchEvent(new Event('change'));
            if (select.value !== 'webcam') {
                const onvifFields = document.getElementById('onvifCredentials') || document.getElementById('liveOnvifCredentials');
                if (onvifFields) onvifFields.classList.remove('d-none');
            }

        } catch (e) {
            console.error('Error discovering cameras:', e);
        } finally {
            btn.innerHTML = originalIcon;
            btn.disabled = false;
        }
    }

    // ==================== SAVED CAMERAS ====================

    async function loadSavedCameras() {
        try {
            const res = await fetch('/cameras');
            savedCameras = await res.json();
            renderSavedCamerasList();
            updateLiveCameraOptions();
        } catch (e) {
            console.error('Error loading cameras:', e);
        }
    }

    function renderSavedCamerasList() {
        const list = document.getElementById('savedCamerasList');
        if (!list) return;

        if (!savedCameras || savedCameras.length === 0) {
            list.innerHTML = '<p class="text-secondary small mb-0">Nenhuma câmera salva.</p>';
            return;
        }

        list.innerHTML = savedCameras.map(cam => {
            const maskedUser = cam.username ? cam.username : '---';
            const maskedPass = cam.password ? '••••' : '---';
            const captureStatus = cam.capture_enabled ? 'Ativo' : 'Desativado';
            const backendStatus = cam.backend_enabled ? 'Ativo' : 'Desativado';
            const captureLocation = cam.capture_location === 'photos'
                ? 'Montado'
                : cam.capture_location === 'custom'
                    ? `Base: ${getCaptureBasePath(cam.capture_path) || 'Personalizado'}`
                    : '/mnt/Capturas';
            return `
                <div class="d-flex justify-content-between align-items-center border-top pt-2 mt-2">
                    <div>
                        <strong>${cam.name}</strong><br>
                        <small class="text-secondary">${cam.rtsp_url}</small><br>
                        <small class="text-secondary">Usuário: ${maskedUser} | Senha: ${maskedPass}</small>
                        <br><small class="text-secondary">Backend: ${backendStatus}</small>
                        <br><small class="text-secondary">Capturas: ${captureStatus} - ${captureLocation}</small>
                    </div>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="selectLiveCamera('${cam.id}')" title="Usar no Ao Vivo">
                            <i class="fas fa-video"></i>
                        </button>
                        <button class="btn btn-outline-secondary" onclick="editCamera('${cam.id}')" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteCamera('${cam.id}')" title="Excluir">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function updateLiveCameraOptions() {
        const select = document.getElementById('liveVideoSource');
        if (!select) return;

        let optgroup = document.getElementById('savedCamerasOptions');
        if (!optgroup) {
            optgroup = document.createElement('optgroup');
            optgroup.label = 'Câmeras Salvas';
            optgroup.id = 'savedCamerasOptions';
            select.appendChild(optgroup);
        }

        optgroup.innerHTML = '';
        savedCameras.forEach(cam => {
            const option = document.createElement('option');
            option.value = `saved:${cam.id}`;
            option.textContent = cam.name;
            optgroup.appendChild(option);
        });
    }

    function openCameraModal(cameraId = null) {
        editingCameraId = cameraId;
        const status = document.getElementById('cameraTestStatus');
        const preview = document.getElementById('cameraTestPreview');
        const testBtn = document.getElementById('cameraTestBtn');

        stopCameraPreview();

        if (status) status.textContent = 'Nenhum teste executado.';
        if (preview) preview.innerHTML = '';
        if (testBtn) testBtn.innerHTML = '<i class="fas fa-vial"></i> Testar';
        cameraPreviewActive = false;

        if (cameraId) {
            const cam = savedCameras.find(c => c.id === cameraId);
            if (!cam) return;
            document.getElementById('cameraName').value = cam.name || '';
            document.getElementById('cameraRtspUrl').value = cam.rtsp_url || '';
            document.getElementById('cameraUsername').value = cam.username || '';
            document.getElementById('cameraPassword').value = cam.password || '';
            document.getElementById('cameraQuality').value = cam.quality || 'auto';
            document.getElementById('cameraLowLatency').checked = cam.low_latency !== false;
            document.getElementById('cameraBackendEnabled').checked = !!cam.backend_enabled;
            document.getElementById('cameraCaptureEnabled').checked = !!cam.capture_enabled;
            document.getElementById('cameraCaptureLocation').value = cam.capture_location || 'data';
            document.getElementById('cameraCapturePath').value = getCaptureBasePath(cam.capture_path);
        } else {
            document.getElementById('cameraName').value = '';
            document.getElementById('cameraRtspUrl').value = '';
            document.getElementById('cameraUsername').value = '';
            document.getElementById('cameraPassword').value = '';
            document.getElementById('cameraQuality').value = 'auto';
            document.getElementById('cameraLowLatency').checked = true;
            document.getElementById('cameraBackendEnabled').checked = false;
            document.getElementById('cameraCaptureEnabled').checked = false;
            document.getElementById('cameraCaptureLocation').value = 'data';
            document.getElementById('cameraCapturePath').value = '';
        }

        toggleCameraCapturePath();
        cameraModal.show();
    }

    async function saveCamera() {
        const name = document.getElementById('cameraName').value.trim();
        const rtspUrl = document.getElementById('cameraRtspUrl').value.trim();
        const username = document.getElementById('cameraUsername').value.trim();
        const password = document.getElementById('cameraPassword').value.trim();
        const quality = document.getElementById('cameraQuality').value;
        const lowLatency = document.getElementById('cameraLowLatency').checked;
        const backendEnabled = document.getElementById('cameraBackendEnabled').checked;
        const captureEnabled = document.getElementById('cameraCaptureEnabled').checked;
        const captureLocation = document.getElementById('cameraCaptureLocation').value;
        const capturePath = document.getElementById('cameraCapturePath').value.trim();

        if (!name || !rtspUrl) {
            alert('Preencha o nome e a URL RTSP.');
            return;
        }

        if (captureEnabled && captureLocation === 'custom' && !capturePath) {
            alert('Informe o caminho da pasta de capturas.');
            return;
        }

        const finalCapturePath = captureLocation === 'custom'
            ? buildCustomCapturePath(capturePath)
            : null;

        try {
            const method = editingCameraId ? 'PUT' : 'POST';
            const url = editingCameraId ? `/cameras/${editingCameraId}` : '/cameras';
            const res = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name,
                    rtsp_url: rtspUrl,
                    username: username || null,
                    password: password || null,
                    quality,
                    low_latency: lowLatency,
                    backend_enabled: backendEnabled,
                    capture_enabled: captureEnabled,
                    capture_location: captureLocation,
                    capture_path: finalCapturePath
                })
            });
            if (!res.ok) {
                throw new Error('Erro ao salvar câmera');
            }
            document.getElementById('cameraName').value = '';
            document.getElementById('cameraRtspUrl').value = '';
            document.getElementById('cameraUsername').value = '';
            document.getElementById('cameraPassword').value = '';
            document.getElementById('cameraQuality').value = 'auto';
            document.getElementById('cameraLowLatency').checked = true;
            document.getElementById('cameraBackendEnabled').checked = false;
            document.getElementById('cameraCaptureEnabled').checked = false;
            document.getElementById('cameraCaptureLocation').value = 'data';
            document.getElementById('cameraCapturePath').value = '';
            toggleCameraCapturePath();
            editingCameraId = null;
            await loadSavedCameras();
            stopCameraPreview();
            cameraModal.hide();
        } catch (e) {
            console.error(e);
            alert('Erro ao salvar câmera');
        }
    }

    function editCamera(cameraId) {
        openCameraModal(cameraId);
    }

    async function testCamera() {
        const rtspUrl = document.getElementById('cameraRtspUrl').value.trim();
        const username = document.getElementById('cameraUsername').value.trim();
        const password = document.getElementById('cameraPassword').value.trim();
        const quality = document.getElementById('cameraQuality').value;
        const lowLatency = document.getElementById('cameraLowLatency').checked;
        const status = document.getElementById('cameraTestStatus');
        const preview = document.getElementById('cameraTestPreview');
        const testBtn = document.getElementById('cameraTestBtn');

        if (!rtspUrl) {
            alert('Informe a URL RTSP antes de testar.');
            return;
        }

        if (cameraPreviewActive) {
            stopCameraPreview();
            return;
        }

        if (status) status.textContent = 'Iniciando preview...';
        if (preview) preview.innerHTML = '';

        try {
            const res = await fetch('/cameras/preview/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    rtsp_url: rtspUrl,
                    username: username || null,
                    password: password || null,
                    quality,
                    low_latency: lowLatency
                })
            });

            if (!res.ok) {
                const data = await res.json();
                if (status) status.textContent = data.detail || 'Falha no preview.';
                return;
            }

            cameraPreviewActive = true;
            if (testBtn) testBtn.innerHTML = '<i class="fas fa-stop"></i> Parar';
            if (status) status.textContent = 'Preview ativo';
            if (preview) {
                preview.innerHTML = `<img src="/cameras/preview/feed?ts=${Date.now()}" class="img-fluid rounded" alt="Preview">`;
            }
        } catch (e) {
            console.error(e);
            if (status) status.textContent = 'Erro ao testar câmera.';
        }
    }

    async function stopCameraPreview() {
        const status = document.getElementById('cameraTestStatus');
        const preview = document.getElementById('cameraTestPreview');
        const testBtn = document.getElementById('cameraTestBtn');

        if (!cameraPreviewActive) {
            return;
        }

        cameraPreviewActive = false;
        if (testBtn) testBtn.innerHTML = '<i class="fas fa-vial"></i> Testar';
        if (preview) preview.innerHTML = '';
        if (status) status.textContent = 'Preview encerrado.';

        try {
            await fetch('/cameras/preview/stop', { method: 'POST' });
        } catch (e) {
            console.error(e);
        }
    }

    function toggleCameraCapturePath() {
        const location = document.getElementById('cameraCaptureLocation').value;
        const group = document.getElementById('cameraCapturePathGroup');
        if (!group) return;
        group.classList.toggle('d-none', location !== 'custom');
        if (location === 'custom') {
            const input = document.getElementById('cameraCapturePath');
            if (input && !input.value.trim()) {
                input.value = '/mnt/Capturas';
            }
        }
    }

    function buildCustomCapturePath(basePath) {
        if (!basePath) return '';
        const normalized = basePath.replace(/\/+$/, '');
        if (normalized.endsWith('/PhotoRecognition/Capturas')) {
            return normalized;
        }
        if (normalized.endsWith('/PhotoRecognition')) {
            return `${normalized}/Capturas`;
        }
        return `${normalized}/PhotoRecognition/Capturas`;
    }

    function getCaptureBasePath(path) {
        if (!path) return '';
        const normalized = path.replace(/\/+$/, '');
        if (normalized.endsWith('/PhotoRecognition/Capturas')) {
            return normalized.replace(/\/PhotoRecognition\/Capturas$/, '');
        }
        if (normalized.endsWith('/PhotoRecognition')) {
            return normalized.replace(/\/PhotoRecognition$/, '');
        }
        return normalized;
    }

    function openCaptureFolderModal() {
        folderSelectionContext = 'capture';
        const input = document.getElementById('cameraCapturePath');
        captureBrowsePath = input?.value?.trim() || '/mnt/Capturas';
        loadCaptureFolders(captureBrowsePath);
        captureFolderModal.show();
    }

    function openOrganizeFolderModal() {
        folderSelectionContext = 'organize';
        const input = document.getElementById('organizeDestination');
        captureBrowsePath = input?.value?.trim() || '/mnt/organized';
        loadCaptureFolders(captureBrowsePath);
        captureFolderModal.show();
    }

    async function refreshCaptureFooter() {
        const textEl = document.getElementById('captureFooterText');
        const tooltip = document.getElementById('captureTooltip');
        if (!textEl) return;

        try {
            const res = await fetch('/captures/recent?limit=1');
            if (!res.ok) {
                return;
            }
            const data = await res.json();
            if (!data.length) {
                textEl.textContent = 'Sem capturas recentes';
                if (tooltip) tooltip.innerHTML = '<div class="text-secondary">Sem capturas recentes</div>';
                return;
            }
            const entry = data[0];
            let label = entry.person_name || entry.label || 'Desconhecido';
            if (label && label.toLowerCase() === 'unknown') {
                label = 'Desconhecido';
            }
            const time = entry.created_at ? new Date(entry.created_at).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : '';
            textEl.textContent = `Rosto capturado: ${label} ${time ? '• ' + time : ''}`;
        } catch (e) {
            console.error('Capture footer error', e);
        }
    }

    async function refreshCaptureFooterDetails() {
        const tooltip = document.getElementById('captureTooltip');
        if (!tooltip) return;

        try {
            const res = await fetch('/captures/recent?limit=10');
            if (!res.ok) {
                return;
            }
            const data = await res.json();
            captureFooterItems = data;
            if (!captureFooterItems.length) {
                tooltip.innerHTML = '<div class="text-secondary">Sem capturas recentes</div>';
                return;
            }
            tooltip.innerHTML = captureFooterItems.map(item => {
                let label = item.person_name || item.label || 'Desconhecido';
                if (label && label.toLowerCase() === 'unknown') {
                    label = 'Desconhecido';
                }
                const time = item.created_at ? new Date(item.created_at).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : '';
                return `
                    <div class="capture-tooltip-item">
                        <span class="capture-tooltip-name">${label}</span>
                        <span class="capture-tooltip-time">${time}</span>
                    </div>
                `;
            }).join('');
        } catch (e) {
            console.error('Capture footer error', e);
        }
    }

    async function openCaptureLogModal() {
        const list = document.getElementById('captureLogList');
        if (!list) return;
        list.innerHTML = '<div class="text-center text-secondary py-3"><i class="fas fa-spinner fa-spin"></i> Carregando...</div>';
        captureLogModal.show();

        try {
            const res = await fetch('/captures/recent?limit=50');
            if (!res.ok) {
                throw new Error('Erro ao carregar capturas');
            }
            const data = await res.json();
            if (!data.length) {
                list.innerHTML = '<div class="text-secondary small">Nenhuma captura recente.</div>';
                return;
            }

            list.innerHTML = data.map(item => {
                let label = item.person_name || item.label || 'Desconhecido';
                if (label && label.toLowerCase() === 'unknown') {
                    label = 'Desconhecido';
                }
                const time = item.created_at
                    ? new Date(item.created_at).toLocaleString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit', day: '2-digit', month: '2-digit' })
                    : '';
                const imageUrl = item.file_path ? item.file_path.replace('/mnt/Capturas', '/capture-files') : '';
                return `
                    <div class="capture-log-item">
                        <img src="${imageUrl}" class="capture-log-thumb" alt="${label}" onclick="window.open('${imageUrl}', '_blank')">
                        <div class="capture-log-info">
                            <strong>${label}</strong>
                            <span>${time}</span>
                            <span class="text-secondary">${item.file_path || ''}</span>
                        </div>
                    </div>
                `;
            }).join('');
        } catch (e) {
            console.error(e);
            list.innerHTML = '<div class="text-danger small">Erro ao carregar capturas.</div>';
        }
    }

    async function loadCaptureFolders(path) {
        const list = document.getElementById('captureFolderList');
        const breadcrumb = document.getElementById('captureBreadcrumb');
        const currentLabel = document.getElementById('captureCurrentPath');
        if (!list) return;

        list.innerHTML = '<div class="text-center text-secondary py-3"><i class="fas fa-spinner fa-spin"></i> Carregando...</div>';
        try {
            const res = await fetch(`/directories?path=${encodeURIComponent(path)}`);
            if (!res.ok) {
                throw new Error('Erro ao carregar pastas');
            }
            const data = await res.json();
            captureBrowsePath = data.path;

            if (currentLabel) currentLabel.textContent = captureBrowsePath;
            if (breadcrumb) renderCaptureBreadcrumb(captureBrowsePath);

            if (!data.directories.length) {
                list.innerHTML = '<div class="text-secondary small">Nenhuma subpasta.</div>';
                return;
            }

            list.innerHTML = data.directories.map(dir => `
                <div class="capture-folder-item" onclick="loadCaptureFolders('${dir.path}')">
                    <i class="fas fa-folder"></i>
                    <span>${dir.name}</span>
                </div>
            `).join('');
        } catch (e) {
            console.error(e);
            list.innerHTML = '<div class="text-danger small">Erro ao carregar pastas.</div>';
        }
    }

    function renderCaptureBreadcrumb(path) {
        const breadcrumb = document.getElementById('captureBreadcrumb');
        if (!breadcrumb) return;

        const parts = path.split('/').filter(Boolean);
        let acc = '';
        let html = '<div class="capture-breadcrumb">';
        parts.forEach((part, idx) => {
            acc += '/' + part;
            if (idx === parts.length - 1) {
                html += `<span>${part}</span>`;
            } else {
                html += `<button type="button" onclick="loadCaptureFolders('${acc}')">${part}</button><span>/</span>`;
            }
        });
        html += '</div>';
        breadcrumb.innerHTML = html;
    }

    async function createCaptureFolder() {
        const input = document.getElementById('captureFolderName');
        const name = input?.value?.trim();
        if (!name) {
            alert('Informe o nome da pasta');
            return;
        }

        try {
            const res = await fetch('/directories', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: captureBrowsePath, name })
            });
            if (!res.ok) {
                throw new Error('Erro ao criar pasta');
            }
            input.value = '';
            loadCaptureFolders(captureBrowsePath);
        } catch (e) {
            console.error(e);
            alert('Erro ao criar pasta');
        }
    }

    function selectCaptureFolder() {
        if (folderSelectionContext === 'organize') {
            const input = document.getElementById('organizeDestination');
            if (input) {
                input.value = captureBrowsePath;
            }
        } else {
            const input = document.getElementById('cameraCapturePath');
            if (input) {
                input.value = captureBrowsePath;
            }
        }
        captureFolderModal.hide();
    }

    async function deleteCamera(cameraId) {
        if (!confirm('Excluir esta câmera salva?')) return;

        try {
            const res = await fetch(`/cameras/${cameraId}`, { method: 'DELETE' });
            if (!res.ok) {
                throw new Error('Erro ao excluir');
            }
            await loadSavedCameras();
        } catch (e) {
            console.error(e);
            alert('Erro ao excluir câmera');
        }
    }

    function selectLiveCamera(cameraId) {
        const select = document.getElementById('liveVideoSource');
        if (!select) return;
        select.value = `saved:${cameraId}`;
        select.dispatchEvent(new Event('change'));
        alert('Câmera selecionada para Ao Vivo');
    }

    function buildRtspUrl(camera) {
        const baseUrl = camera?.rtsp_url || '';
        if (!baseUrl) return '';

        if (!camera.username && !camera.password) {
            return baseUrl;
        }

        if (baseUrl.includes('@')) {
            return baseUrl;
        }

        const parts = baseUrl.split('://');
        if (parts.length < 2) return baseUrl;

        const scheme = parts[0];
        const rest = parts.slice(1).join('://');
        const user = encodeURIComponent(camera.username || '');
        const pass = camera.password ? `:${encodeURIComponent(camera.password)}` : '';
        return `${scheme}://${user}${pass}@${rest}`;
    }

    function getPersonPhotoLimit() {
        const value = window.cacheSettings?.personPhotoLimit ?? 30;
        return Math.max(6, value);
    }

    function getPreloadCount() {
        const value = window.cacheSettings?.preloadCount ?? 6;
        return Math.max(0, value);
    }

    function getLiveVideoConstraints(quality) {
        const presets = {
            '360p': { width: 640, height: 360 },
            '480p': { width: 854, height: 480 },
            '720p': { width: 1280, height: 720 },
            '1080p': { width: 1920, height: 1080 }
        };
        if (!quality || quality === 'auto' || !presets[quality]) {
            return true;
        }
        const { width, height } = presets[quality];
        return {
            width: { ideal: width },
            height: { ideal: height }
        };
    }

    function getFaceThumbSize() {
        const faceSize = parseInt(document.getElementById('settingsFaceSize')?.value || '80', 10);
        return Math.max(60, faceSize);
    }

    function buildPhotoThumbUrl(photoId) {
        return `/thumb/${photoId}?size=480`;
    }

    function buildFaceThumbUrl(faceId) {
        const size = getFaceThumbSize();
        return `/face/${faceId}/thumb?size=${size}`;
    }

    function preloadViewerImages(startIndex) {
        const count = getPreloadCount();
        if (!viewerPhotos.length || count === 0) return;
        for (let i = 1; i <= count; i++) {
            const idx = (startIndex + i) % viewerPhotos.length;
            const photo = viewerPhotos[idx];
            if (!photo) continue;
            const img = new Image();
            img.src = photo.path;
        }
    }

    function preloadViewerThumbs(startIndex) {
        const count = getPreloadCount();
        if (!viewerPhotos.length || count === 0) return;
        for (let i = 0; i <= count; i++) {
            const idx = (startIndex + i) % viewerPhotos.length;
            const photo = viewerPhotos[idx];
            if (!photo || !photo.photo_id) continue;
            const img = new Image();
            img.src = buildPhotoThumbUrl(photo.photo_id);
        }
    }

    function warmThumbCache(photos) {
        if (!Array.isArray(photos) || photos.length === 0) return;
        const photoIds = photos.map(photo => photo.photo_id).filter(Boolean);
        photoIds.slice(0, 200).forEach(photoId => {
            const img = new Image();
            img.src = buildPhotoThumbUrl(photoId);
        });

        fetch('/cache/warmup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ photo_ids: photoIds.slice(0, 200), size: 480 })
        }).catch(() => {});
    }

    function markerCacheKey(photoId, faceId) {
        return `${photoId}:${faceId}`;
    }

    function getMarkerFromCache(photoId, faceId, displayWidth, displayHeight) {
        const cached = markerCache.get(markerCacheKey(photoId, faceId));
        if (!cached) return null;
        if (!cached.rel || cached.rel.length !== 4) return null;
        return {
            left: cached.rel[0] * displayWidth,
            top: cached.rel[1] * displayHeight,
            width: cached.rel[2] * displayWidth,
            height: cached.rel[3] * displayHeight
        };
    }

    function setMarkerCache(photoId, faceId, displayWidth, displayHeight, markerLeft, markerTop, markerWidth, markerHeight) {
        if (!photoId || !faceId) return;
        if (!displayWidth || !displayHeight) return;
        const rel = [
            markerLeft / displayWidth,
            markerTop / displayHeight,
            markerWidth / displayWidth,
            markerHeight / displayHeight
        ];

        markerCache.set(markerCacheKey(photoId, faceId), {
            rel,
            updated_at: Date.now()
        });

        if (markerCache.size > MARKER_CACHE_LIMIT) {
            const firstKey = markerCache.keys().next().value;
            markerCache.delete(firstKey);
        }

        scheduleMarkerCacheSave();
    }

    function scheduleMarkerCacheSave() {
        clearTimeout(markerCacheSaveTimeout);
        markerCacheSaveTimeout = setTimeout(saveMarkerCache, 800);
    }

    function saveMarkerCache() {
        try {
            const entries = Array.from(markerCache.entries());
            localStorage.setItem(MARKER_CACHE_KEY, JSON.stringify({ entries }));
        } catch (e) {
            console.warn('Marker cache save failed', e);
        }
    }

    function loadMarkerCache() {
        try {
            const raw = localStorage.getItem(MARKER_CACHE_KEY);
            if (!raw) return;
            const data = JSON.parse(raw);
            if (!data || !Array.isArray(data.entries)) return;
            data.entries.forEach(([key, value]) => {
                markerCache.set(key, value);
            });
        } catch (e) {
            console.warn('Marker cache load failed', e);
        }
    }


    async function checkVideoStatus() {
        // Only discover if not using webcam (to find RTSP streams)
        // But auto-discover once just in case
        if (!camerasDiscovered) {
            camerasDiscovered = true;
            discoverCameras();
        }

        const select = document.getElementById('videoSource');
        if (select) {
            select.value = 'webcam';
            select.dispatchEvent(new Event('change'));
        }
        
        // Check if backend is processing an RTSP stream
        try {
            const res = await fetch('/video/status');
            const data = await res.json();
            
            if (data.active && data.source !== 'webcam') {
                // Backend streaming RTSP
                showVideoUI(true, data.source);
                document.getElementById('videoContainer').innerHTML = `
                    <img src="/video/stream?ts=${Date.now()}" style="max-width: 100%; max-height: 500px; border-radius: 8px;" alt="Video Feed" class="live-feed-image">
                `;
            } else if (videoStream) {
                 // Browser Webcam active
                 showVideoUI(true, 'Webcam Local');
            } else {
                showVideoUI(false);
            }
        } catch(e) { console.error(e); }
    }

    function updateLiveUiState(active, sourceName = '') {
        const status = document.getElementById('liveVideoStatus');
        if (active) {
            status.innerHTML = `Status: <span class="text-success">Conectado</span> ${sourceName ? `- ${sourceName}` : ''}`;
        } else {
            status.innerHTML = 'Status: <span class="text-secondary">Desconectado</span>';
            document.getElementById('liveVideoContainer').innerHTML = `
                <div class="text-secondary">
                    <i class="fas fa-video fa-2x mb-2 d-block"></i>
                    <p>Ative o vídeo para iniciar</p>
                </div>
            `;
        }
    }

    function renderLiveRecognition(data) {
        if (!data || data.faces_detected === 0) {
            document.getElementById('liveRecognitionResults').innerHTML = `
                <div class="text-secondary text-center py-3">
                    <i class="fas fa-user-slash"></i> Nenhum rosto detectado
                </div>
            `;
            return;
        }

        let html = `<div class="recognition-list">`;
        data.results.forEach(r => {
            if (r.recognized) {
                html += `
                    <button type="button" class="recognition-item" onclick="openPersonModal(${r.person_id})">
                        <span class="recognition-icon"><i class="fas fa-user-check"></i></span>
                        <span class="recognition-text"><strong>${r.person_name}</strong><span class="recognition-score">${Math.round(r.similarity * 100)}%</span></span>
                        <span class="recognition-action"><i class="fas fa-chevron-right"></i></span>
                    </button>
                `;
            } else {
                html += `
                    <div class="recognition-item recognition-unknown">
                        <span class="recognition-icon"><i class="fas fa-user-times"></i></span>
                        <span class="recognition-text">Desconhecido</span>
                    </div>
                `;
            }
        });
        html += `</div>`;
        document.getElementById('liveRecognitionResults').innerHTML = html;

        if (!document.getElementById('recognitionHistory')?.classList.contains('d-none')) {
            refreshRecognitionHistory();
        }
    }

    function toggleRecognitionHistory() {
        const panel = document.getElementById('recognitionHistory');
        if (!panel) return;
        panel.classList.toggle('d-none');
        if (!panel.classList.contains('d-none')) {
            refreshRecognitionHistory();
        }
    }

    async function clearRecognitionHistory() {
        try {
            await fetch('/recognition/history', { method: 'DELETE' });
            recognitionHistory = [];
            renderRecognitionHistory();
        } catch (e) {
            console.error('Error clearing history:', e);
        }
    }

    async function refreshRecognitionHistory() {
        try {
            const res = await fetch('/recognition/history?limit=50');
            recognitionHistory = await res.json();
            renderRecognitionHistory();
        } catch (e) {
            console.error('Error loading history:', e);
        }
    }

    function renderRecognitionHistory() {
        const list = document.getElementById('recognitionHistoryList');
        if (!list) return;

        if (!recognitionHistory.length) {
            list.innerHTML = '<div class="recognition-history-empty">Sem histórico ainda</div>';
            return;
        }

        list.innerHTML = recognitionHistory.map(entry => {
            const timeLabel = entry.created_at
                ? new Date(entry.created_at).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit' })
                : '';
            const isClickable = !!entry.person_id;
            return `
                <${isClickable ? 'button' : 'div'} type="button" class="recognition-item recognition-history-item" ${isClickable ? `onclick=\"openPersonModal(${entry.person_id})\"` : ''}>
                    <span class="recognition-icon"><i class="fas fa-user"></i></span>
                    <span class="recognition-text">
                        <strong>${entry.person_name || 'Desconhecido'}</strong>
                        <span class="recognition-history-time">${timeLabel}</span>
                    </span>
                    <span class="recognition-action"><i class="fas fa-chevron-right"></i></span>
                </${isClickable ? 'button' : 'div'}>
            `;
        }).join('');
    }

    function toggleLiveMode() {
        const enabled = document.getElementById('liveEnabled').checked;
        if (enabled) {
            startLiveVideo();
        } else {
            stopLiveVideo();
        }
    }

    async function toggleLivePip() {
        const container = document.getElementById('liveVideoContainer');
        if (!container) return;
        const videoEl = container.querySelector('video');

        if (videoEl && document.pictureInPictureEnabled) {
            try {
                if (document.pictureInPictureElement) {
                    await document.exitPictureInPicture();
                } else {
                    await videoEl.requestPictureInPicture();
                }
            } catch (e) {
                console.error('PiP error:', e);
            }
            return;
        }

        const enabled = !container.classList.contains('pip-active');
        container.classList.toggle('pip-active', enabled);

        if (enabled) {
            enablePipDrag(container);
        } else {
            disablePipDrag(container);
        }
    }

    function enablePipDrag(container) {
        if (!container) return;
        container.style.left = '';
        container.style.top = '';
        container.style.right = '20px';
        container.style.bottom = '20px';

        if (!container.querySelector('.pip-handle')) {
            const handle = document.createElement('div');
            handle.className = 'pip-handle';
            container.appendChild(handle);
        }

        let dragging = false;
        let resizing = false;
        let startX = 0;
        let startY = 0;
        let startWidth = 0;
        let startHeight = 0;
        let startLeft = 0;
        let startTop = 0;

        const handle = container.querySelector('.pip-handle');
        const onMouseMove = (e) => {
            if (resizing) {
                const newWidth = Math.max(220, startWidth + (e.clientX - startX));
                const newHeight = Math.max(140, startHeight + (e.clientY - startY));
                container.style.width = `${newWidth}px`;
                container.style.height = `${newHeight}px`;
            } else if (dragging) {
                container.style.left = `${startLeft + (e.clientX - startX)}px`;
                container.style.top = `${startTop + (e.clientY - startY)}px`;
                container.style.right = 'auto';
                container.style.bottom = 'auto';
            }
        };
        const onMouseUp = () => {
            dragging = false;
            resizing = false;
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        };

        container.onmousedown = (e) => {
            if (e.target === handle) return;
            dragging = true;
            startX = e.clientX;
            startY = e.clientY;
            const rect = container.getBoundingClientRect();
            startLeft = rect.left;
            startTop = rect.top;
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        };

        handle.onmousedown = (e) => {
            e.stopPropagation();
            resizing = true;
            startX = e.clientX;
            startY = e.clientY;
            startWidth = container.offsetWidth;
            startHeight = container.offsetHeight;
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        };
    }

    function disablePipDrag(container) {
        if (!container) return;
        container.onmousedown = null;
        const handle = container.querySelector('.pip-handle');
        if (handle) {
            handle.onmousedown = null;
            handle.remove();
        }
        container.style.width = '';
        container.style.height = '';
    }

    async function startLiveVideo() {
        const sourceSelect = document.getElementById('liveVideoSource');
        let source = sourceSelect.value;
        let sourceLabel = sourceSelect.options[sourceSelect.selectedIndex]?.textContent || '';
        let quality = document.getElementById('liveQuality')?.value || 'auto';
        let lowLatency = document.getElementById('liveLowLatency')?.checked ?? true;
        let cameraId = null;

        if (source.startsWith('saved:')) {
            cameraId = source.replace('saved:', '');
            const camera = savedCameras.find(c => c.id === cameraId);
            if (!camera) {
                alert('Câmera salva não encontrada.');
                document.getElementById('liveEnabled').checked = false;
                return;
            }
            source = buildRtspUrl(camera);
            sourceLabel = camera.name || sourceLabel || 'Câmera Salva';
            cameraId = camera.id;
            if (camera.quality) {
                quality = camera.quality;
            }
            if (camera.low_latency !== undefined) {
                lowLatency = camera.low_latency;
            }
        }

        if (source === 'custom') {
            source = document.getElementById('liveCustomRtspUrl').value;
            if (!source) {
                alert('Digite a URL RTSP');
                document.getElementById('liveEnabled').checked = false;
                return;
            }
        }

        document.getElementById('liveRecognitionResults').innerHTML = `
            <div class="text-secondary text-center py-3">
                <div class="spinner-border spinner-border-sm"></div> Conectando...
            </div>
        `;

        if (source === 'webcam') {
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('Seu navegador não liberou acesso à câmera. Use HTTPS ou localhost.');
                }
                const constraints = getLiveVideoConstraints(quality);
                videoStream = await navigator.mediaDevices.getUserMedia({ video: constraints });
                const videoEl = document.createElement('video');
                videoEl.srcObject = videoStream;
                videoEl.play();

                const container = document.getElementById('liveVideoContainer');
                container.innerHTML = '';
                container.appendChild(videoEl);
                container.onclick = toggleLivePip;

                updateLiveUiState(true, 'Webcam Local');
                liveVideoInterval = setInterval(() => processWebcamFrame(videoEl, true), 1200);
            } catch (err) {
                console.error('Error accessing webcam:', err);
                alert('Erro ao acessar webcam local: ' + err.message);
                document.getElementById('liveEnabled').checked = false;
                updateLiveUiState(false);
            }
        } else {
            try {
                const res = await fetch('/video/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source,
                        quality,
                        low_latency: lowLatency,
                        camera_id: cameraId
                    })
                });
                const data = await res.json();
                if (data.success) {
                    document.getElementById('liveVideoContainer').innerHTML = `
                        <img src="/video/stream?ts=${Date.now()}" alt="Video Feed" class="live-feed-image">
                    `;
                    document.getElementById('liveVideoContainer').onclick = toggleLivePip;
                    updateLiveUiState(true, sourceLabel || data.source);
                    liveVideoInterval = setInterval(async () => {
                        const res = await fetch('/video/recognize', { method: 'POST' });
                        const data = await res.json();
                        renderLiveRecognition(data);
                    }, 2000);
                } else {
                    alert('Erro: ' + (data.error || 'Falha ao conectar'));
                    document.getElementById('liveEnabled').checked = false;
                    updateLiveUiState(false);
                }
            } catch (e) {
                console.error(e);
                alert('Erro ao conectar');
                document.getElementById('liveEnabled').checked = false;
                updateLiveUiState(false);
            }
        }
    }

    async function stopLiveVideo() {
        clearInterval(liveVideoInterval);
        const container = document.getElementById('liveVideoContainer');
        if (container) {
            container.classList.remove('pip-active');
            container.onclick = null;
        }
        if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
            videoStream = null;
            updateLiveUiState(false);
            renderLiveRecognition({ faces_detected: 0, results: [] });
        } else {
            try {
                await fetch('/video/stop', { method: 'POST' });
            } catch (e) {
                console.error(e);
            }
            updateLiveUiState(false);
            renderLiveRecognition({ faces_detected: 0, results: [] });
        }
    }

    
    function showVideoUI(active, sourceName = '') {
        const startBtn = document.getElementById('btnStartVideo');
        const stopBtn = document.getElementById('btnStopVideo');
        const captureBtn = document.getElementById('btnCapture');
        const status = document.getElementById('videoStatus');

        if (!startBtn || !stopBtn || !status) {
            return;
        }
        
        if (active) {
            startBtn.classList.add('d-none');
            stopBtn.classList.remove('d-none');
            if (captureBtn) captureBtn.disabled = false;
            status.innerHTML = `Status: <span class="text-success">Conectado</span> ${sourceName ? `- ${sourceName}` : ''}`;
        } else {
            startBtn.classList.remove('d-none');
            stopBtn.classList.add('d-none');
            if (captureBtn) captureBtn.disabled = true;
            status.innerHTML = 'Status: <span class="text-secondary">Desconectado</span>';
            const container = document.getElementById('videoContainer');
            if (container) {
                container.innerHTML = `
                    <div class="text-secondary">
                        <i class="fas fa-video fa-3x mb-3 d-block"></i>
                        <p>Selecione uma fonte e clique em Iniciar</p>
                    </div>
                `;
            }
            const results = document.getElementById('recognitionResults');
            if (results) {
                results.innerHTML = `
                    <div class="text-secondary text-center py-3">
                        <i class="fas fa-video-slash"></i> Vídeo não iniciado
                    </div>
                `;
            }
        }
    }

    async function startVideo() {
        const sourceSelect = document.getElementById('videoSource');
        let source = sourceSelect.value;

        if (source === 'custom') {
            source = document.getElementById('customRtspUrl').value;
            if (!source) {
                alert('Digite a URL RTSP');
                return;
            }
        }

        document.getElementById('videoStatus').innerHTML = 'Status: <span class="text-warning">Conectando...</span>';

        if (source === 'webcam') {
            // Browser-side Webcam
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('Seu navegador não liberou acesso à câmera. Use HTTPS ou localhost.');
                }
                videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
                
                const videoEl = document.createElement('video');
                videoEl.srcObject = videoStream;
                videoEl.play();
                videoEl.style.maxWidth = '100%';
                videoEl.style.maxHeight = '500px';
                videoEl.style.borderRadius = '8px';
                
                document.getElementById('videoContainer').innerHTML = '';
                document.getElementById('videoContainer').appendChild(videoEl);
                
                showVideoUI(true, 'Webcam Local');
                
                // Start sending frames for recognition
                // Don't send every frame, maybe 2fps to save bandwidth/cpu
                videoInterval = setInterval(() => processWebcamFrame(videoEl), 1000);

                
            } catch (err) {
                console.error("Error accessing webcam:", err);
                alert("Erro ao acessar webcam local: " + err.message);
                showVideoUI(false);
            }
        } else {
            // Server-side RTSP
            try {
                const res = await fetch('/video/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ source })
                });
                const data = await res.json();

                if (data.success) {
                    showVideoUI(true, data.source);
                    document.getElementById('videoContainer').innerHTML = `
                        <img src="/video/stream?ts=${Date.now()}" style="max-width: 100%; max-height: 500px; border-radius: 8px;" alt="Video Feed" onerror="this.style.display='none'" class="live-feed-image">
                    `;
                } else {
                    alert('Erro: ' + (data.error || 'Falha ao conectar'));
                    showVideoUI(false);
                }
            } catch (e) {
                console.error(e);
                alert('Erro ao conectar');
                showVideoUI(false);
            }
        }
    }
    
    async function processWebcamFrame(videoEl, isLive = false) {
        if (!videoEl || videoEl.readyState < 2) return;
        
        VIDEO_CANVAS.width = videoEl.videoWidth;
        VIDEO_CANVAS.height = videoEl.videoHeight;
        VIDEO_CTX.drawImage(videoEl, 0, 0, VIDEO_CANVAS.width, VIDEO_CANVAS.height);
        
        // Get image data and send to server
        VIDEO_CANVAS.toBlob(async (blob) => {
            if (!blob) return;
            
            const formData = new FormData();
            formData.append('file', blob, 'frame.jpg');
            
            try {
                // Use a new endpoint for frame processing without saving
                const res = await fetch('/video/process_frame', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                if (isLive) {
                    renderLiveRecognition(data);
                } else {
                    displayRecognitionResults(data);
                }
            } catch (e) {
                console.error("Frame processing error", e);
            }
        }, 'image/jpeg', 0.8);
    }

    async function stopVideo() {
        if (videoStream && !document.getElementById('liveEnabled')?.checked) {
            // Stop local webcam
            videoStream.getTracks().forEach(track => track.stop());
            videoStream = null;
            clearInterval(videoInterval);
            showVideoUI(false);
        } else if (!document.getElementById('liveEnabled')?.checked) {
            // Stop server RTSP
            try {
                await fetch('/video/stop', { method: 'POST' });
                showVideoUI(false);
            } catch (e) {
                console.error(e);
            }
        }

        if (document.getElementById('liveEnabled')?.checked) {
            document.getElementById('liveEnabled').checked = false;
            stopLiveVideo();
        }
    }

    async function captureAndRecognize() {
        if (videoStream) {
             // Manual capture from local webcam
             const videoEl = document.querySelector('#videoContainer video');
             if (videoEl) {
                 processWebcamFrame(videoEl); // Just trigger one processing
             }
        } else {
            // Server side capture
        const recognitionResults = document.getElementById('recognitionResults');
        if (recognitionResults) {
            recognitionResults.innerHTML = `
                <div class="text-center py-3">
                    <div class="spinner-border spinner-border-sm"></div> Analisando...
                </div>
            `;
        }

            try {
                const res = await fetch('/video/recognize', { method: 'POST' });
                const data = await res.json();
                displayRecognitionResults(data);
            } catch (e) {
                console.error(e);
            const recognitionResults = document.getElementById('recognitionResults');
            if (recognitionResults) {
                recognitionResults.innerHTML = `
                    <div class="alert alert-danger mb-0">
                        <i class="fas fa-exclamation-triangle"></i> Erro ao analisar
                    </div>
                `;
            }

            }
        }
    }
    
    function displayRecognitionResults(data) {
        if (data.faces_detected === 0) {
            const recognitionResults = document.getElementById('recognitionResults');
            if (recognitionResults) {
                recognitionResults.innerHTML = `
                    <div class="alert alert-warning mb-0">
                        <i class="fas fa-user-slash"></i> Nenhum rosto detectado
                    </div>
                `;
            }
            return;
        }

        let html = `<div class="recognition-list">`;
        data.results.forEach((r, i) => {
            if (r.recognized) {
                html += `
                    <button type="button" class="recognition-item" onclick="openPersonModal(${r.person_id})">
                        <span class="recognition-icon"><i class="fas fa-user-check"></i></span>
                        <span class="recognition-text"><strong>${r.person_name}</strong><span class="recognition-score">${Math.round(r.similarity * 100)}%</span></span>
                        <span class="recognition-action"><i class="fas fa-chevron-right"></i></span>
                    </button>
                `;
            } else {
                html += `
                    <div class="recognition-item recognition-unknown">
                        <span class="recognition-icon"><i class="fas fa-user-times"></i></span>
                        <span class="recognition-text">Desconhecido</span>
                    </div>
                `;
            }
        });
        html += `</div>`;
        const recognitionResults = document.getElementById('recognitionResults');
        if (recognitionResults) {
            recognitionResults.innerHTML = html;
        }
    }


    async function resetAndRescan() {
        const rescan = document.getElementById('rescanAfterReset').checked;
        const checkboxes = document.querySelectorAll('.folder-check:checked');
        const selectedFolders = Array.from(checkboxes).map(cb => cb.value);

        let confirmMsg = 'ATENÇÃO: Isso irá remover TODOS os dados indexados (fotos, rostos, pessoas).\n\nAs fotos originais NÃO serão afetadas.\n\n';
        if (rescan) {
            confirmMsg += 'Após limpar, será iniciado um novo scan.\n\n';
        }
        confirmMsg += 'Deseja continuar?';

        if (!confirm(confirmMsg)) return;

        try {
            // Reset database
            const resetRes = await fetch('/reset', { method: 'POST' });
            const resetData = await resetRes.json();

            if (!resetData.success) {
                alert('Erro ao limpar: ' + (resetData.detail || 'Desconhecido'));
                return;
            }

            updateStats();
            loadGroups();

            if (rescan && selectedFolders.length > 0) {
                // Trigger scan with selected folders
                await fetch('/scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ folders: selectedFolders })
                });
                alert('Histórico limpo e scan iniciado! Acompanhe o progresso no rodapé.');
                loadPersons();
            } else {
                // Show welcome modal to start fresh
                loadWelcomeFolders();
                welcomeModal.show();
            }
        } catch (e) {
            console.error(e);
            alert('Erro ao executar operação.');
        }
    }

    // ==================== SCAN CONTROL ====================

    async function pauseScan() {
        try {
            const res = await fetch('/scan/pause', { method: 'POST' });
            const data = await res.json();
            if (data.success) {
                scanPaused = true;
                updateStats();
            }
        } catch (e) {
            console.error(e);
            alert('Erro ao pausar scan.');
        }
    }

    async function resumeScan() {
        try {
            const res = await fetch('/scan/resume', { method: 'POST' });
            const data = await res.json();
            if (data.success) {
                scanPaused = false;
                updateStats();
            }
        } catch (e) {
            console.error(e);
            alert('Erro ao continuar scan.');
        }
    }

    async function stopScan() {
        if (!confirm('Tem certeza que deseja parar o scan? O progresso será perdido.')) return;
        try {
            const res = await fetch('/scan/stop', { method: 'POST' });
            const data = await res.json();
            if (data.success) {
                scanPaused = false;
                updateStats();
            }
        } catch (e) {
            console.error(e);
            alert('Erro ao parar scan.');
        }
    }
</script>
</body>
</html>
